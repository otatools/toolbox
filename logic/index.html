<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ¨ç†ã‚²ãƒ¼ãƒ ãƒ»çœŸå®Ÿã‚’è§£æ˜ã›ã‚ˆï¼</title>
<style>
body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #0b1a11; color: #e0d9c1; text-align: center; padding: 5px; margin: 0; touch-action: manipulation; overflow-x: hidden; }
.container { max-width: 900px; width: 95%; margin: 5px auto; background: #1a2e22; padding: 15px; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 2px solid #a6894a; position: relative; box-sizing: border-box; }
h1 { color: #a6894a; margin-bottom: 10px; font-size: 1.4em; }
.hidden { display: none !important; }
#room-id-display-top { position: absolute; top: 10px; left: 10px; font-size: 0.7em; color: #a6894a; opacity: 0.8; z-index: 101; }
#timer-display { background: #e94560; color: white; padding: 3px 12px; border-radius: 20px; font-weight: bold; position: sticky; top: 0; z-index: 100; display: inline-block; margin-bottom: 5px; border: 2px solid #fff; font-size: 0.9em; }
label { display: block; text-align: left; margin: 5px 0 2px; font-size: 0.8em; color: #8e9e94; }
input, select, button { width: 100%; padding: 10px; margin-bottom: 8px; border-radius: 4px; border: none; box-sizing: border-box; font-size: 16px; }
input, select { background: #0b1a11; color: #e0d9c1; border: 1px solid #a6894a; appearance: none; -webkit-appearance: none; }
select option { background: #0b1a11; color: #e0d9c1; }
.flex-row { display: flex; gap: 10px; }
.flex-row > * { flex: 1; }
button { background: #a6894a; color: #1a2e22; font-weight: bold; cursor: pointer; transition: 0.2s; }
button:disabled { background: #444; color: #888; cursor: not-allowed; }
.btn-secondary { background: #4e7c5a; color: white; }
.btn-accent { background: #e94560; color: white; margin-top: 10px; }
.tab-menu { display: flex; gap: 5px; margin-bottom: 10px; }
.tab-btn { flex: 1; padding: 8px; font-size: 0.8em; background: #0b1a11; color: #a6894a; border: 1px solid #a6894a; }
.tab-btn.active { background: #a6894a; color: #1a2e22; }
.info-card { background: #0b1a11; padding: 12px; border-radius: 4px; border: 1px inset #a6894a; text-align: left; margin-bottom: 8px; }
.player-item { border-bottom: 1px solid #333; padding: 12px 0; font-size: 0.85em; display: flex; flex-direction: row; justify-content: space-between; align-items: center; text-align: left; transition: 0.3s; }
.item-info { flex: 1; line-height: 1.6; }
.item-name { color: #a6894a; font-weight: bold; font-size: 1.1em; display: block; margin-bottom: 4px; }
.item-details { display: flex; flex-wrap: wrap; gap: 4px 8px; align-items: center; color: #e0d9c1; }
.list-cell { display: inline-block; }
.divider { color: #444; }
.check-controls { display: flex; flex-direction: row; gap: 5px; margin-top: 0; margin-left: 2px; }
.check-btn { padding: 6px 8px; font-size: 0.75em; border-radius: 4px; border: 1px solid #a6894a; background: transparent; color: #a6894a; margin-bottom: 0; white-space: nowrap; width: auto; flex: none; }
.btn-reset { border-color: #8e9e94; color: #8e9e94; }
.status-suspect { border-left: 4px solid #e94560; background: rgba(233, 69, 96, 0.15) !important; padding-left: 8px; }
.status-safe { border-bottom: none !important; }
.status-safe .item-info, .status-safe .check-btn:not(.btn-reset) { opacity: 0.3; filter: grayscale(1); }
#event-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px; box-sizing: border-box; }
.typewriter-box { color: #4ecca3; font-family: monospace; font-size: 1.5em; text-align: left; width: 100%; max-width: 600px; min-height: 100px; margin-bottom: 30px; line-height: 1.6; }
.event-text { color: #e94560; font-size: 3.5em; font-weight: bold; transform: scale(0); text-shadow: 0 0 25px rgba(233,69,96,0.7); text-align: center; width: 100%; margin-top: 20px; word-break: break-all; }
.stamp-anim { animation: stamp 0.5s forwards ease-in; }
@keyframes stamp { 0% { transform: scale(5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
#memo-container { background: white; border-radius: 4px; position: relative; overflow: hidden; touch-action: none; width: 100%; }
canvas { width: 100%; height: 60vh; cursor: crosshair; display: block; }
.memo-tools { display: flex; gap: 5px; margin-top: 5px; }
.memo-tools button { padding: 8px; font-size: 0.8em; flex: 1; }
.tool-active { background: #e94560 !important; color: white !important; }
@keyframes revealCulprit { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
.reveal-animation { animation: revealCulprit 1.5s ease-out forwards; }
.winner-tag { display: inline-block; background: #4ecca3; color: #1a2e22; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 0.9em; }
footer { margin-top: 20px; font-size: 0.7em; color: #4e7c5a; opacity: 0.8; }
</style>
</head>
<body>

<div id="event-overlay" class="hidden">
<div id="event-typewriter" class="typewriter-box"></div>
<div id="event-title-display" class="event-text"></div>
</div>

<div class="container">
<div id="room-id-display-top" class="hidden">äº‹ä»¶ç•ªå·: <span id="top-room-id">----</span></div>
<div id="game-timer" class="hidden"><span id="timer-display">æ®‹ã‚Š --:--</span></div>
<h1 id="main-title">ğŸ” æ¨ç†ã‚²ãƒ¼ãƒ ãƒ»çœŸå®Ÿã‚’è§£æ˜ã›ã‚ˆï¼</h1>

<div id="setup-screen">
<h2>èª¿æŸ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
<div class="flex-row">
<div><label>ã¿ã‚‡ã†ã˜ (ã²ã‚‰ãŒãª)</label><input type="text" id="p-last-name" placeholder="ã¿ã‚‡ã†ã˜"></div>
<div><label>ãªã¾ãˆ (ã²ã‚‰ãŒãª)</label><input type="text" id="p-first-name" placeholder="ãªã¾ãˆ"></div>
</div>
<div class="flex-row">
<div><label>ã°ã‚“ã”ã†</label><select id="p-id"></select></div>
<div><label>ãŸã‚“ã˜ã‚‡ã†æœˆ</label><select id="p-month"></select></div>
<div><label>ãŸã‚“ã˜ã‚‡ã†æ—¥</label><select id="p-day"></select></div>
</div>
<button id="btn-create-mode">æ¢åµäº‹å‹™æ‰€ã‚’é–‹ã (è¦ªæ©Ÿ)</button>
<button id="btn-join-mode" class="btn-secondary">èª¿æŸ»ã«å‚åŠ ã™ã‚‹ (å­æ©Ÿ)</button>
</div>

<div id="join-screen" class="hidden">
<h2>äº‹ä»¶ç•ªå·ã®å…¥åŠ›</h2>
<input type="text" id="input-room-id" placeholder="0000" inputmode="numeric" autocomplete="off">
<button id="btn-confirm-join">äº‹å‹™æ‰€ã«å…¥ã‚‹</button>
</div>

<div id="lobby-screen" class="hidden">
<h2>äº‹ä»¶ç•ªå·: <span id="display-room-id" style="color:#a6894a;">----</span></h2>
<p style="text-align: right; margin: 0; font-size: 0.9em; color: #4ecca3;">ç¾åœ¨ï¼š<span id="player-count">0</span>åãŒå…¥å®¤ä¸­</p>
<div class="info-card" id="player-list"></div>
<div id="host-controls" class="hidden">
<label>æœæŸ»åˆ¶é™æ™‚é–“</label>
<select id="game-duration"></select>
<button id="start-game-btn">èª¿æŸ»é–‹å§‹ï¼</button>
</div>
<div id="guest-waiting" class="hidden">
<p>æ¢åµã‚’å‹Ÿé›†ä¸­ã§ã™...</p>
</div>
</div>

<div id="game-screen" class="hidden">
<div class="tab-menu" id="game-tabs">
<button class="tab-btn active" id="tab-btn-hint" onclick="switchTab('tab-hint')">ãƒ’ãƒ³ãƒˆ</button>
<button class="tab-btn" id="tab-btn-list" onclick="switchTab('tab-list')">æœæŸ»åç°¿</button>
<button class="tab-btn" id="tab-btn-memo" onclick="switchTab('tab-memo')">ãƒ¡ãƒ¢</button>
</div>
<div id="tab-hint">
<div class="info-card">
<h3 style="color:#a6894a; margin:0; font-size:1em;">ğŸ“‹ ç™ºç”Ÿã—ãŸäº‹ä»¶</h3>
<p id="incident-text" style="font-size:0.9em; margin: 5px 0;"></p>
</div>
<div class="info-card" style="border-color:#e94560;">
<h3 style="color:#e94560; margin:0; font-size:1em;">ğŸ’¡ ã‚ãªãŸã®æ‰‹ãŒã‹ã‚Š</h3>
<p id="my-hint" style="font-weight:bold; font-size:1.1em; color:#fff; margin: 5px 0;"></p>
</div>
<div id="answered-status" class="info-card hidden" style="text-align:center;">
<p style="color:#4ecca3; margin:0;">å›ç­”ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚<br>å…¨å“¡ãŒæƒã†ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚</p>
</div>
<button class="btn-accent" id="btn-solve-open">çŠ¯äººãŒåˆ†ã‹ã£ãŸï¼</button>
</div>
<div id="tab-list" class="hidden" style="max-height: 70vh; overflow-y: auto;">
<div class="info-card" id="investigation-list"></div>
</div>
<div id="tab-memo" class="hidden">
<div id="memo-container">
<canvas id="memo-canvas"></canvas>
</div>
<div class="memo-tools">
<button id="btn-pen" class="btn-secondary tool-active" onclick="setTool('pen')">ãƒšãƒ³</button>
<button id="btn-eraser" class="btn-secondary" onclick="setTool('eraser')">æ¶ˆã—ã‚´ãƒ </button>
<button class="btn-secondary" style="background:#444;" onclick="clearCanvas()">å…¨æ¶ˆã—</button>
</div>
</div>
</div>

<div id="solve-screen" class="hidden">
<h2>çŠ¯äººã‚’ç‰¹å®šã›ã‚ˆ</h2>
<div id="suspect-list" style="max-height: 50vh; overflow-y: auto;"></div>
<button onclick="switchTab('tab-hint')" class="btn-secondary" style="margin-top:10px;">ã¾ã è€ƒãˆç›´ã™</button>
</div>

<div id="result-screen" class="hidden">
<h2 id="result-header">çœŸå®Ÿã¯ã„ã¤ã‚‚ï¼‘ã¤ï¼</h2>
<div class="info-card" id="result-main" style="text-align:center;">
<div id="culprit-animation-area">
<p id="result-incident-title" style="color:#a6894a; font-weight:bold;"></p>
<p style="font-size:1.2em;">çŠ¯äººã¯â€¦</p>
<p id="culprit-reveal" class="reveal-animation" style="color:#e94560; font-size:1.8em; font-weight:bold; margin: 20px 0;"></p>
</div>
<div id="winner-section" style="border-top:1px solid #a6894a; padding-top:15px; margin-top:15px;">
<p id="winner-title" style="font-size:0.9em; color:#4ecca3;">âœ¨ çœŸå®Ÿã«ãŸã©ã‚Šç€ã„ãŸæ¢åµ âœ¨</p>
<div id="winner-list"></div>
</div>
</div>
<button onclick="location.reload()" class="btn-secondary">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
</div>

<footer>
æ¨ç†ã‚²ãƒ¼ãƒ  | Ver 21.8.1 | ota tools
</footer>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, collection, onSnapshot, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyCCPSYYB0NMg4BpnyhUO8PW6bLvzjb_uoU",
authDomain: "logic-73279.firebaseapp.com",
projectId: "logic-73279",
storageBucket: "logic-73279.firebasestorage.app",
messagingSenderId: "138225936033",
appId: "1:138225936033:web:a3e02e1bbed8044f7532e0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let investigationStatus = {}; 

const runTypewriter = (el, text, speed, append = false) => {
    return new Promise(resolve => {
        const baseText = append ? el.innerText : "";
        const startTime = performance.now();
        const timer = setInterval(() => {
            const elapsed = performance.now() - startTime;
            const charCount = Math.floor(elapsed / 80); // é€Ÿåº¦ã‚’80ã«å›ºå®š
            el.innerText = baseText + text.substring(0, charCount);
            if (charCount >= text.length) {
                clearInterval(timer);
                resolve();
            }
        }, 30);
    });
};

const robustWait = (ms) => {
    return new Promise(resolve => {
        const startTime = performance.now();
        const check = () => {
            if (performance.now() - startTime >= ms) resolve();
            else setTimeout(check, 50);
        };
        check();
    });
};

const restrictToHiragana = (el) => {
    el.addEventListener('input', (e) => {
        if (e.isComposing) return;
        const val = e.target.value;
        const filtered = val.replace(/[^ã-ã‚“\s]/g, '');
        if (val !== filtered) e.target.value = filtered;
    });
    el.addEventListener('compositionend', (e) => {
        const val = e.target.value;
        const filtered = val.replace(/[^ã-ã‚“\s]/g, '');
        if (val !== filtered) e.target.value = filtered;
    });
};

restrictToHiragana(document.getElementById('p-last-name'));
restrictToHiragana(document.getElementById('p-first-name'));

const roomIdInput = document.getElementById('input-room-id');
roomIdInput.addEventListener('input', (e) => {
    let val = e.target.value;
    val = val.replace(/[ï¼-ï¼™]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
    val = val.replace(/[^0-9]/g, '');
    e.target.value = val;
});

const idSel = document.getElementById('p-id');
for(let i=1; i<=40; i++) idSel.add(new Option(i + "ç•ª", i));
const mSel = document.getElementById('p-month');
for(let i=1; i<=12; i++) mSel.add(new Option(i + "æœˆ", i));
const dSel = document.getElementById('p-day');
for(let i=1; i<=31; i++) dSel.add(new Option(i + "æ—¥", i));

const durationSel = document.getElementById('game-duration');
for(let i=1; i<=15; i++) {
const opt = new Option(i + "åˆ†", i);
if(i === 5) opt.selected = true;
durationSel.add(opt);
}

const loadProfile = () => {
const saved = localStorage.getItem('detective_profile');
if (saved) {
const data = JSON.parse(saved);
document.getElementById('p-last-name').value = data.last || "";
document.getElementById('p-first-name').value = data.first || "";
document.getElementById('p-id').value = data.id || 1;
document.getElementById('p-month').value = data.month || 1;
document.getElementById('p-day').value = data.day || 1;
}
};
const saveProfileLocal = (last, first, id, month, day) => {
const data = { last, first, id, month, day };
localStorage.setItem('detective_profile', JSON.stringify(data));
};
loadProfile();

let isHost = false, myRoomId = "", myProfile = null, players = [], hasAnswered = false;

const incidentData = [
    { title: "ä¼èª¬ã®å½«åˆ»åˆ€ç´›å¤±äº‹ä»¶", detail: "å›³å·¥ã®æ™‚é–“ã€ç”·å­å…¨å“¡ã®ã‚ã“ãŒã‚Œã€Œæ¼†é»’ã®é¾ã€ãŒå½«ã‚‰ã‚ŒãŸä¸–ç•Œä¸€ã‹ã£ã“ã„ã„å½«åˆ»åˆ€ãŒã‚±ãƒ¼ã‚¹ã”ã¨æ¶ˆãˆã¦ã—ã¾ã£ãŸã€‚ä¸€ä½“ã ã‚ŒãŒæŒã¡å»ã£ãŸã®ã‹â€¦ã€‚" },
    { title: "ä¸‰è§’å®šè¦ã‚«ãƒ‰æ¬ ã‘äº‹ä»¶", detail: "ç®—æ•°ã®æˆæ¥­å‰ã€å…ˆç”ŸãŒæ„›ç”¨ã™ã‚‹å·¨å¤§ä¸‰è§’å®šè¦ã®ã‚«ãƒ‰ãŒæ¿€ã—ãæ¬ ã‘ã¦ã„ãŸã€‚ãƒãƒ£ã‚¤ãƒ ã®ç›´å‰ã€æ•™å®¤ã«ã¯å…¨å“¡ã„ãŸã¯ãšã ãŒã€è½ã¨ã—ãŸçŠ¯äººã¯ã ã‚Œã ï¼Ÿ" },
    { title: "ãƒãƒ§ãƒ¼ã‚¯ç²‰ç •äº‹ä»¶", detail: "é»’æ¿ã®ãƒãƒ§ãƒ¼ã‚¯ãŒã™ã¹ã¦ç²‰ã€…ã«è¸ã¿ã¤ã¶ã•ã‚Œã€ä»Šæ—¥ã®æˆæ¥­ãŒå§‹ã‚ã‚‰ã‚Œãªã„ã€‚å…ˆç”Ÿã«æ¨ã¿ã‚’ã‚‚ã¤è€…ã®çŠ¯è¡Œãªã®ã‹ï¼Ÿä¸€ä½“ã ã‚ŒãŒä½•ã®ãŸã‚ã«ï¼ï¼Ÿ" },
    { title: "é«˜ç´šãƒ—ãƒªãƒ³æ¶ˆå¤±äº‹ä»¶", detail: "å…ˆç”ŸãŒå®¶åº­ç§‘å®¤ã®å†·è”µåº«ã«éš ã—ã¦ã„ãŸã€3ã¤æ˜Ÿãƒ‘ãƒ†ã‚£ã‚·ã‚¨ã®é«˜ç´šãƒ—ãƒªãƒ³ãŒæ¶ˆãˆãŸï¼ã‚´ãƒŸç®±ã«æ®‹ã•ã‚ŒãŸç©ºå®¹å™¨â€¦â€¦é£Ÿã¹ãŸçŠ¯äººã¯ã ã‚Œã ï¼ï¼Ÿ" },
    { title: "é«˜ç´šãƒªã‚³ãƒ¼ãƒ€ãƒ¼ã™ã‚Šæ›¿ãˆäº‹ä»¶", detail: "éŸ³æ¥½ã®æˆæ¥­ã€ã„ã–å¹ã“ã†ã¨ã—ãŸã‚‰å…ˆç”Ÿã®ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ã§ã§ããŸãƒªã‚³ãƒ¼ãƒ€ãƒ¼ãŒã€100å††ã‚·ãƒ§ãƒƒãƒ—ã®ã‚‚ã®ã¨å…¥ã‚Œæ›¿ã‚ã£ã¦ã„ãŸï¼ä¸­èº«ã‚’æ›¿ãˆãŸã®ã¯ã ã‚Œã ï¼ï¼Ÿ" },
    { title: "æ¶ˆãˆãŸãƒ†ã‚¹ãƒˆè§£ç­”ç”¨ç´™ã®è¬", detail: "å…ˆç”ŸãŒæ¡ç‚¹æ¸ˆã¿ãƒ†ã‚¹ãƒˆã‚’æŒã£ã¦æ•™å®¤ã«å‘ã‹ã£ã¦ã„ã‚‹ã¨ã€æ€¥ã«ç›®ã®å‰ãŒçœŸã£æš—ã«ï¼æ°—ã¥ãã¨ãƒ†ã‚¹ãƒˆç”¨ç´™ãŒãªããªã£ã¦ã„ãŸã€‚å¥ªã„å»ã£ãŸçŠ¯äººã¯ã ã‚Œã ï¼Ÿ" },
    { title: "é‡‘é­šé‰¢ã®æ°´ã‚ãµã‚Œäº‹ä»¶", detail: "ã¿ã‚“ãªã§é£¼ã£ã¦ã„ã‚‹é‡‘é­šé‰¢ã®ãµãŸãŒé–‹ã‘ã‚‰ã‚Œã€åºŠãŒæ°´æµ¸ã—ã«ãªã£ã¦ã„ã‚‹ã€‚ã ã‚Œã‹ãŒæ·±å¤œã«é‡‘é­šã¨éŠã¼ã†ã¨ã—ãŸã®ã‹ã€ãã‚Œã¨ã‚‚â€¦â€¦ã€‚" },
    { title: "çµ¦é£Ÿã®å”æšã’è¶³ã‚Šãªã„äº‹ä»¶", detail: "æ¥½ã—ã¿ã«ã—ã¦ã„ãŸå”æšã’ãŒã€è¨ˆç®—ã‚ˆã‚Šã‚‚1ã¤è¶³ã‚Šãªã„ã€‚åºŠã«ã‚‚è½ã¡ã¦ã„ãªã„ã“ã¨ã‹ã‚‰ã€çŠ¯è¡Œã¯é…è†³ä¸­ã«çµã‚‰ã‚ŒãŸã€‚ã“ã£ãã‚Šã¤ã¾ã¿é£Ÿã„ã—ãŸçŠ¯äººã‚’æœã›ï¼" },
    { title: "é»’æ¿ã‚¢ãƒ¼ãƒˆè½æ›¸ãäº‹ä»¶", detail: "ã‚¯ãƒ©ã‚¹å…¨å“¡ã§æã„ãŸãƒãƒ§ãƒ¼ã‚¯ã®ã‚¤ãƒ©ã‚¹ãƒˆã«ã€èµ¤ã„ãƒãƒ§ãƒ¼ã‚¯ã§å¤‰ãªãƒ’ã‚²ã®è½æ›¸ããŒåŠ ãˆã‚‰ã‚Œã¦ã„ã‚‹ã€‚ã“ã®èŠ¸è¡“ã‚’æ±šã—ãŸã®ã¯ä¸€ä½“ã ã‚Œã ï¼Ÿ" },
    { title: "æ›¸é“ç­†ã‚«ãƒã‚«ãƒäº‹ä»¶", detail: "ç¿’å­—ã®æˆæ¥­ã€ç­†ã‚’åºƒã’ã‚ˆã†ã¨ã—ãŸã‚‰ç³Šã§å›ºã‚ãŸã‚ˆã†ã«ã‚«ãƒã‚«ãƒã«ãªã£ã¦ã„ãŸã€‚å˜ãªã‚‹æ´—ã„å¿˜ã‚Œã‹ã€ãã‚Œã¨ã‚‚çœŸçŠ¯äººãŒã„ã‚‹ã®ã‹â€¦ã€‚" },
    { title: "ãŠã—ã‚ƒã‚Œã™ãã‚‹ä¸Šé´äº‹ä»¶", detail: "ä¸‹é§„ç®±ã«ç½®ã„ã¦ã„ãŸä¸Šé´ãŒã€é€±æ˜ã‘ã«è¦‹ã‚‹ã¨ã€Œãƒ—ãƒ¼ãƒ—ãƒ¼ã€ã¨éŸ³ãŒé³´ã‚Šã€ã‚­ãƒ©ã‚­ãƒ©å…‰ã‚‹æ”¹é€ ã‚’æ–½ã•ã‚Œã¦ã„ãŸï¼ã ã‚ŒãŒä½•ã®ç›®çš„ã§ï¼ï¼Ÿ" },
    { title: "ç†ç§‘å®¤ã®ã‚¬ã‚¤ã‚³ãƒ„ç§»å‹•äº‹ä»¶", detail: "ã ã‚Œã‚‚ã„ãªã„ã¯ãšã®ç†ç§‘å®¤ã§äººä½“æ¨¡å‹ã®æ‰‹ã®è§’åº¦ãŒå¤‰ã‚ã£ã¦ã„ãŸã€‚æ˜¼é–“ãªã®ã§ãŠåŒ–ã‘ã®ä»•æ¥­ã§ã¯ãªã„ã¯ãšã€‚æ¨¡å‹ã‚’å‹•ã‹ã—ãŸçŠ¯äººã¯ã ã‚Œã ï¼" },
    { title: "æ¶ˆã—ã‚´ãƒ ã‚«ã‚¹å¤§é‡åé›†äº‹ä»¶", detail: "ä¼‘ã¿æ˜ã‘ã€ç‰¹å®šã®æœºã®ä¸Šã«å±±ã®ã‚ˆã†ãªæ¶ˆã—ã‚´ãƒ ã®ã‚«ã‚¹ãŒé™ã‚Šç©ã‚‚ã£ã¦ã„ãŸã€‚ã“ã‚Œã»ã©ã®æ‰‹é–“ã‚’ã‹ã‘ãŸçŠ¯äººã¯ä¸€ä½“ã ã‚Œãªã‚“ã ï¼Ÿ" },
    { title: "æ”¾é€å®¤ã®è¬ã®é¼»æ­Œäº‹ä»¶", detail: "æ˜¼ã®æ”¾é€ãŒçµ‚ã‚ã£ãŸç›´å¾Œã€ãƒã‚¤ã‚¯ã‹ã‚‰å°ã•ãªé¼»æ­ŒãŒå…¨æ ¡ã«æµã‚Œã¦ã—ã¾ã£ãŸï¼æ”¾é€å§”å“¡ã®åˆ‡ã‚Šå¿˜ã‚Œã‹ã€ãã‚Œã¨ã‚‚â€¦ã€‚ã„ã£ãŸã„ã ã‚Œã®é¼»æ­Œãªã‚“ã ï¼Ÿ" },
    { title: "ãƒã‚±ãƒ„ã®ä¸­èº«é€†è»¢äº‹ä»¶", detail: "æƒé™¤ã®æ™‚é–“ã€ãƒã‚±ãƒ„ã‚’æŒã£ã¦ã“ã‚ˆã†ã¨ã—ãŸã‚‰ã€ä¸­èº«ãŒæ°´ã§ã¯ãªãç ‚ã§ãƒ‘ãƒ³ãƒ‘ãƒ³ã«ã•ã‚Œã¦ã„ãŸã€‚ã“ã‚“ãªæ‰‹ã®è¾¼ã‚“ã ã‚¤ã‚¿ã‚ºãƒ©ã‚’ã™ã‚‹ã®ã¯ã ã‚Œã ï¼Ÿ" },
    { title: "å®¶åº­ç§‘å®¤ã®å¡©ãƒ»ç ‚ç³–é€†è»¢äº‹ä»¶", detail: "èª¿ç†å®Ÿç¿’ã®ãƒ‘ãƒ³ã‚±ãƒ¼ã‚­ãŒã¨ã‚“ã§ã‚‚ãªãã—ã‚‡ã£ã±ã„ï¼ç ‚ç³–ã¨å¡©ã®ä¸­èº«ãŒå…¥ã‚Œæ›¿ãˆã‚‰ã‚Œã¦ã„ãŸã®ã ã€‚ã¿ã‚“ãªã®æ¥½ã—ã¿ã‚’å¥ªã£ãŸçŠ¯äººã‚’è¿½ãˆï¼" },
    { title: "ä¸­åº­ã®ã²ã¾ã‚ã‚Šå·¨å¤§åŒ–äº‹ä»¶", detail: "1æœ¬ã ã‘ã€ä»–ã®3å€ã®é«˜ã•ã«æˆé•·ã—ãŸã²ã¾ã‚ã‚Šã€‚å¤œä¸­ã«ã“ã£ãã‚Šç§˜å¯†ã®è‚¥æ–™ã‚’ä¸ãˆç¶šã‘ã¦ã„ã‚‹ã®ã¯èª°ãªã‚“ã ï¼Ÿ" },
    { title: "æ•™å“ã®ä¸‹ã®ãƒ©ãƒ–ãƒ¬ã‚¿ãƒ¼äº‹ä»¶", detail: "æ•™å“ã®ä¸‹ã«ã€ãƒãƒ¼ãƒˆãƒãƒ¼ã‚¯ã§å°ã‚’ã•ã‚ŒãŸåå‰ã®ãªã„ãƒ©ãƒ–ãƒ¬ã‚¿ãƒ¼ãŒã€‚ä¸­èº«ã‚’èª­ã‚“ã§ã¿ã‚‹ã¨â€¦â€¦ã€‚ã“ã‚Œã‚’æ›¸ã„ãŸã®ã¯ã ã‚Œã ï¼Ÿ" },
    { title: "ãƒªãƒƒãƒ”ãƒ¼èª˜æ‹äº‹ä»¶", detail: "æ¸…åŸå…ˆç”ŸãŒå¤§åˆ‡ã«ã—ã¦ã„ã‚‹ãƒªãƒƒãƒ”ãƒ¼ãŒçªç„¶æ¶ˆãˆã¦ã—ã¾ã£ãŸã€‚æœºã®ä¸Šã«ç½®ã„ã¦ã„ãŸã¯ãšãªã®ã«â€¦â€¦ã€‚é€£ã‚Œå»ã£ãŸçŠ¯äººã¯ã ã‚Œã ï¼" },
    { title: "èŠ±ç“¶ã®è¬ã®æ¶²ä½“äº‹ä»¶", detail: "æ•™å“ã®èŠ±ç“¶ã‹ã‚‰ã€ãªãœã‹ã»ã†ã˜èŒ¶ã®é¦™ã‚ŠãŒã™ã‚‹ã€‚æ°´ã®ä»£ã‚ã‚Šã«æ¯æ—¥æ–°ã—ã„ãŠèŒ¶ã‚’æ³¨ã„ã§ã„ã‚‹ã®ã¯ã€ä¸€ä½“ã ã‚Œã ï¼" },
    { title: "æ¶ˆãˆãŸã‚·ãƒ¼ãƒ«äº‹ä»¶", detail: "ã¿ã‚“ãªãŒã‚³ãƒ„ã‚³ãƒ„é›†ã‚ã¦ã„ãŸæ¼¢å­—ã‚·ãƒ¼ãƒ«ãŒã¾ã‚‹ã”ã¨æ¶ˆãˆã¦ã—ã¾ã£ãŸã€‚åŠªåŠ›ã‚’å¥ªã„ã€è‡ªåˆ†ã®ã‚‚ã®ã«ã—ã‚ˆã†ã¨ã—ãŸçŠ¯äººã¯ã ã‚Œã â€¦ã€‚" },
    { title: "é‹å‹•ä¼šã®ãƒãƒãƒã‚­çµã³äº‹ä»¶", detail: "é‹å‹•ä¼šå‰æ—¥ã€èµ¤çµ„ã®ãƒãƒãƒã‚­ãŒã™ã¹ã¦ã‚¬ãƒã‚¬ãƒã®å›ºçµã³ã§ã¤ãªãŒã‚Œã¦ã„ãŸã€‚ã“ã‚Œã‚’ã‚„ã£ãŸã®ã¯ã€ã‚‚ã—ã‹ã—ã¦ç™½çµ„ã®â€¦ï¼Ÿ" },
    { title: "æœºã®ä¸Šã®ä¸æ€è­°ãªæŠ˜ã‚Šç´™äº‹ä»¶", detail: "æœã€ç™»æ ¡ã™ã‚‹ã¨å…¨å“¡ã®æœºã«ã€Œé‡‘è‰²ã®ã‚«ã‚¨ãƒ«ã€ã®æŠ˜ã‚Šç´™ãŒã€‚ä¸€ä½“ã ã‚ŒãŒã€ã©ã‚“ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¾¼ã‚ã¦ç½®ã„ãŸã®ã ã‚ã†ã‹ï¼Ÿ" },
    { title: "ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¯ãƒ©ãƒƒã‚·ãƒ¥äº‹ä»¶", detail: "å…¨æ ¡ã‚¿ã‚¤ãƒ”ãƒ³ã‚°å¤§ä¼šå½“æ—¥ã€æ–°è²å…ˆç”Ÿã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ã€ŒAã€ã ã‘ãŒæŠœãå–ã‚‰ã‚Œã¦ã„ãŸï¼ã‚ˆã‚Šã«ã‚‚ã‚ˆã£ã¦â€¦â€¦ã€‚çŠ¯äººã¯ä¸€ä½“ã ã‚Œã ï¼ï¼Ÿ" },
    { title: "ãƒ”ã‚¢ãƒã®ãµãŸã®è¬ãƒ¡ãƒ¢äº‹ä»¶", detail: "éŸ³æ¥½å®¤ã®ãƒ”ã‚¢ãƒã‚’é–‹ã‘ã‚‹ã¨ã€ã€Œæ¬¡ã¯å›³å·¥å®¤ã¸è¡Œã‘ï¼ã‚²ãƒ¼ãƒ ã®ã¯ã˜ã¾ã‚Šã ï¼ã€ã¨ã„ã†æŒ‘æˆ¦çŠ¶ãŒã€‚ã“ã®ã‚²ãƒ¼ãƒ ã‚’ä»•çµ„ã‚“ã çŠ¯äººã¯ã ã‚Œã ï¼Ÿ" },
    { title: "ç¿’å­—ã®åŠç´™èŠ±ä¸¸äº‹ä»¶", detail: "æå‡ºå‰ã®ä½œå“ã«ã€å‹æ‰‹ã«ã€Œå„ªå‹ã€ã¨å¤§ããªèŠ±ä¸¸ãŒæã‹ã‚Œã¦ã„ãŸã€‚å…ˆç”Ÿã®ãµã‚Šã‚’ã—ã¦å‹æ‰‹ã«å„ªå‹ã‚’æ±ºã‚ãŸçŠ¯äººã¯ã ã‚Œãªã‚“ã ï¼" },
    { title: "æ ¡åº­ã®å·¨å¤§ãªåœ°ä¸Šçµµã®è¬", detail: "æœã®ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã€ã»ã†ãã§æã‹ã‚ŒãŸå·¨å¤§ãªã€Œã®ã€ã®å­—ãŒå‡ºç¾ã—ãŸã€‚ã“ã‚“ãªãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãªè½æ›¸ãã‚’ã—ãŸçŠ¯äººã¯ã ã‚Œã ï¼Ÿ" },
    { title: "ã‚«ãƒ‹ã®è¶³ãƒãƒƒã‚­ãƒ³äº‹ä»¶", detail: "å­¦æ ¡ä¸­ã®ã‚«ãƒ‹ã®ã‚¤ãƒ©ã‚¹ãƒˆã®è¶³ãŒ2æœ¬ã«æãç›´ã•ã‚Œã€å…ˆç”Ÿã®å¤§åˆ‡ãªã‚«ãƒ‹ã®ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã¾ã§è¶³ã‚’æŠ˜ã‚‰ã‚Œã¦ã„ã‚‹ï¼ä¸€ä½“ã ã‚ŒãŒï¼ï¼Ÿ" },
    { title: "é»’æ¿çœŸã£ç™½ã‘äº‹ä»¶", detail: "æˆæ¥­ã‚’å§‹ã‚ã‚ˆã†ã¨ã—ãŸã‚‰ã€ãªã‚“ã¨é»’æ¿ãŒãƒãƒ§ãƒ¼ã‚¯ã§çœŸã£ç™½ã«å¡—ã‚‰ã‚Œã¦ã„ãŸï¼è²´é‡ãªãƒãƒ§ãƒ¼ã‚¯ã‚’ç„¡é§„é£ã„ã—ãŸçŠ¯äººã‚’æœã›ï¼" },
    { title: "èµ¤ã„ãƒšãƒ³å…ˆå…¥ã‚Œæ›¿ãˆäº‹ä»¶", detail: "èµ¤ãƒšãƒ³ã§ä¸¸ã‚’ã¤ã‘ã‚ˆã†ã¨ã—ãŸã‚‰ã€é’ã„è‰²ãŒå‡ºã¦ããŸï¼ä¸­èº«ã‚’å·§å¦™ã«å…¥ã‚Œæ›¿ãˆãŸã®ã¯ã€ä¸€ä½“ã ã‚Œã ï¼" },
    { title: "ä¸Šå±¥ãå·¦å³é€†è»¢äº‹ä»¶", detail: "ä¸‹é§„ç®±ã®ä¸Šå±¥ããŒã€å…¨ã‚¯ãƒ©ã‚¹åˆ†ã€Œå³ã¨å·¦ã€å…¥ã‚Œæ›¿ã‚ã£ã¦ã„ãŸã€‚åœ°å‘³ãªãŒã‚‰å¤§å¤‰ãªä½œæ¥­ã‚’ã‚„ã‚Šé‚ã’ãŸçŠ¯äººã¯èª°ã ï¼Ÿ" },
    { title: "ã¨ã¦ã‚‚å„ªã—ã„ã‚ã®å­ã‚’æœã›", detail: "å¤±æ•—ã—ã¦è½ã¡è¾¼ã‚“ã§ã„ã‚‹å…ˆç”Ÿã®æœºã«ã€Œå…ƒæ°—å‡ºã—ã¦ãã ã•ã„ï¼ã€ã¨ã„ã†ãƒ¡ãƒ¢ãŒâ€¦ã€‚ã“ã‚“ãªã«å„ªã—ã„ãƒ¡ãƒ¢ã‚’ãã‚ŒãŸã®ã¯èª°ã ï¼ï¼Ÿ" },
    { title: "è¬ã®ãŠç¬‘ã„å¤§ä¼šå„ªå‹è€…ã‚’æœã›", detail: "æ ¡å†…ãŠç¬‘ã„å¤§ä¼šã§å¤§çˆ†ç¬‘ã‚’ã•ã‚‰ã£ãŸè¬ã®ãŠé¢å‡ºå ´è€…ã€‚æ–‡å¥ãªã—ã®å„ªå‹ã«è¼ã„ãŸã€æ­£ä½“ä¸æ˜ã®é¢ç™½ã„äººã¯èª°ãªã‚“ã ã‚ã†ï¼Ÿ" },
    { title: "é€†ã•ã¾ã«è²¼ã‚‰ã‚ŒãŸãƒã‚¹ã‚¿ãƒ¼ã®è¬", detail: "å»Šä¸‹ã®æ²ç¤ºç‰©ãŒã™ã¹ã¦æ­£ç¢ºã«ã€Œé€†ã•ã¾ã€ã«è²¼ã‚Šç›´ã•ã‚Œã¦ã„ãŸã€‚ã‹ãªã‚Šã®åŸ·å¿µã‚’æ„Ÿã˜ã‚‹ã“ã®çŠ¯è¡Œã€çŠ¯äººã¯ã ã‚Œã ï¼Ÿ" },
    { title: "çµ¦é£Ÿã®ç™½è¡£ãƒœã‚¿ãƒ³ç´›å¤±äº‹ä»¶", detail: "çµ¦é£Ÿå½“ç•ªãŒç€ã‚ˆã†ã¨ã—ãŸç™½è¡£ã®ãƒœã‚¿ãƒ³ãŒã€ã™ã¹ã¦å–ã‚Œã¦ã„ãŸã€‚ç³¸ã‚’ã‚ã–ã¨åˆ‡ã£ã¦å«ŒãŒã‚‰ã›ã‚’ã—ãŸã®ã¯ä¸€ä½“ã ã‚Œã ï¼" },
    { title: "æ ¡é•·å…ˆç”Ÿã®æ¤…å­å›ºå®šäº‹ä»¶", detail: "æ ¡é•·å®¤ã®æ¤…å­ãŒã€éƒ¨å±‹ã®éš…ã‚’å‘ã„ãŸã¾ã¾ã‚¬ãƒã‚¬ãƒã«å›ºå®šã•ã‚Œã¦ã„ãŸã€‚æ ¡é•·å…ˆç”Ÿã‚’é©šã‹ã›ãŸçŠ¯äººã¯ã ã‚Œãªã‚“ã ï¼Ÿ" },
    { title: "æ°´é£²ã¿å ´ã®ã‚­ãƒ©ã‚­ãƒ©çŸ³äº‹ä»¶", detail: "æ°´é£²ã¿å ´ã®ã™ã¹ã¦ã®è›‡å£ã®ä¸Šã«ã€å·ã§æ‹¾ã£ãŸã‚ˆã†ãªã‚­ãƒ©ã‚­ãƒ©ã—ãŸçŸ³ãŒç½®ã‹ã‚Œã¦ã„ãŸã€‚ã ã‚ŒãŒä½•ã®ãŸã‚ã«â€¦ã€‚" },
    { title: "æ¶ˆãˆãŸãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«ã®ç©ºæ°—", detail: "ä½“è‚²é¤¨ã®ãƒœãƒ¼ãƒ«20å€‹ã™ã¹ã¦ã®ç©ºæ°—ãŒã€åŠåˆ†ã ã‘æŠœã‹ã‚Œã¦ã„ãŸã€‚å¼¾ã¾ãªã„ãƒœãƒ¼ãƒ«â€¦â€¦ã ã‚Œã®ä»•æ¥­ã ï¼" },
    { title: "å›³æ›¸å®¤ã®å›³é‘‘å…¥ã‚Œæ›¿ãˆäº‹ä»¶", detail: "å›³æ›¸å®¤ã®ã€å®‡å®™å›³é‘‘ã€ã®ã‚±ãƒ¼ã‚¹ã«ã€æç«œå›³é‘‘ã€ãŒâ€¦ã€‚å…¨éƒ¨ã®ä¸­èº«ãŒãƒãƒ©ãƒãƒ©ã§å¤§æ··ä¹±ï¼å›³æ›¸å®¤ã‚’ãƒ¡ãƒãƒ£ã‚¯ãƒãƒ£ã«ã—ãŸçŠ¯äººã¯ã ã‚Œã ï¼Ÿ" },
    { title: "ãƒ©ã‚±ãƒƒãƒˆãµã«ã‚ƒãµã«ã‚ƒäº‹ä»¶", detail: "å¤ªç”°å…ˆç”Ÿã®ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ãƒ©ã‚±ãƒƒãƒˆãŒã€ã“ã‚“ã«ã‚ƒãã®ã‚ˆã†ã«ãµã«ã‚ƒãµã«ã‚ƒã«ï¼ï¼Ÿä¸€ä½“ã ã‚ŒãŒï¼ï¼Ÿâ€¦ã¨ã„ã†ã‹ã€ã©ã†ã‚„ã£ã¦ã‚„ã£ãŸã®ï¼Ÿ" }
];

const colorMap = { "èµ¤è‰²": "#ff4d4d", "é’è‰²": "#4d94ff", "é»„è‰²": "#ffff4d", "ç·‘è‰²": "#4dff88" };
const colors = Object.keys(colorMap);

const getDisplayColor = (colorName) => {
    return colorMap[colorName] || "#ffffff";
};

// --- Canvaså‡¦ç† ---
const canvas = document.getElementById('memo-canvas');
const ctx = canvas.getContext('2d');
let drawing = false, currentTool = 'pen', canvasInitialized = false;

function initCanvas() {
if(canvasInitialized) return;
canvas.width = canvas.parentElement.clientWidth;
canvas.height = canvas.parentElement.clientHeight || window.innerHeight * 0.6;
ctx.lineCap = 'round'; ctx.lineWidth = 4;
canvasInitialized = true;
}
canvas.addEventListener('pointerdown', (e) => { drawing = true; ctx.beginPath(); const rect = canvas.getBoundingClientRect(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top); });
canvas.addEventListener('pointermove', (e) => { if(drawing) { const rect = canvas.getBoundingClientRect(); ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top); ctx.globalCompositeOperation = (currentTool === 'eraser') ? 'destination-out' : 'source-over'; ctx.strokeStyle = (currentTool === 'eraser') ? 'rgba(0,0,0,1)' : '#1a2e22'; ctx.lineWidth = (currentTool === 'eraser') ? 20 : 4; ctx.stroke(); } });
canvas.addEventListener('pointerup', () => { drawing = false; });
window.setTool = (tool) => { currentTool = tool; document.getElementById('btn-pen').classList.toggle('tool-active', tool === 'pen'); document.getElementById('btn-eraser').classList.toggle('tool-active', tool === 'eraser'); };
window.clearCanvas = () => { if(confirm("ãƒ¡ãƒ¢ã‚’å…¨éƒ¨æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) ctx.clearRect(0, 0, canvas.width, canvas.height); };

window.switchTab = (tabId) => {
document.querySelectorAll('#game-screen > div:not(.tab-menu), #solve-screen, #result-screen').forEach(el => el.classList.add('hidden'));
document.getElementById(tabId).classList.remove('hidden');
document.querySelectorAll('.tab-btn').forEach(btn => {
const attr = btn.getAttribute('onclick');
if(attr) {
const bId = attr.match(/'([^']+)'/)[1];
btn.classList.toggle('active', bId === tabId);
}
});
if(tabId === 'tab-memo') initCanvas();
if(tabId === 'solve-screen') window.renderSuspectButtons();
};

const getBasicProfile = () => {
const last = document.getElementById('p-last-name').value.trim(), first = document.getElementById('p-first-name').value.trim();
const id = document.getElementById('p-id').value;
const month = document.getElementById('p-month').value;
const day = document.getElementById('p-day').value;
if(!last || !first) { alert("ãªã¾ãˆã‚’å…¥åŠ›ã—ã¦ã­"); return null; }
saveProfileLocal(last, first, id, month, day);
return {
name: last + " " + first,
lastName: last,
firstName: first,
fullName: last + first,
idNum: parseInt(id),
m: parseInt(month), d: parseInt(day)
};
};

document.getElementById('btn-create-mode').onclick = async () => {
myProfile = getBasicProfile(); if(!myProfile) return;
isHost = true; myRoomId = Math.floor(1000 + Math.random() * 9000).toString();
await setDoc(doc(db, "rooms", myRoomId), { 
    status: "waiting", 
    host: myProfile.name,
    createdAt: Date.now() 
});
enterLobby(myRoomId);
};

// è¦ªæ©Ÿï¼ˆãƒ›ã‚¹ãƒˆï¼‰ãŒç”»é¢ã‚’é–‰ã˜ãŸã¨ãã«éƒ¨å±‹ã‚’å‰Šé™¤ã™ã‚‹
window.addEventListener('beforeunload', () => {
    if (isHost && myRoomId) {
        deleteDoc(doc(db, "rooms", myRoomId));
    }
});

document.getElementById('btn-join-mode').onclick = () => { if(getBasicProfile()) { document.getElementById('setup-screen').classList.add('hidden'); document.getElementById('join-screen').classList.remove('hidden'); }};

document.getElementById('btn-confirm-join').onclick = async () => {
myProfile = getBasicProfile(); const rId = document.getElementById('input-room-id').value;
const snap = await getDoc(doc(db, "rooms", rId));
if(snap.exists()) { myRoomId = rId; enterLobby(rId); } else alert("ç•ªå·ãŒã¡ãŒã„ã¾ã™");
};

async function enterLobby(roomId) {
await setDoc(doc(db, "rooms", roomId, "players", myProfile.name), { ...myProfile, isHost, answer: null, answerTime: null });
document.getElementById('display-room-id').innerText = roomId;
document.getElementById('top-room-id').innerText = roomId; 
document.getElementById('room-id-display-top').classList.remove('hidden'); 

document.getElementById('setup-screen').classList.add('hidden');
document.getElementById('join-screen').classList.add('hidden');
document.getElementById('lobby-screen').classList.remove('hidden');
if(isHost) document.getElementById('host-controls').classList.remove('hidden');
else document.getElementById('guest-waiting').classList.remove('hidden');

onSnapshot(collection(db, "rooms", roomId, "players"), (snap) => {
players = []; const list = document.getElementById('player-list'); list.innerHTML = "";
let answeredCount = 0;
snap.forEach(d => {
const p = d.data(); players.push(p);
if(p.answer) answeredCount++;
});
players.sort((a, b) => a.idNum - b.idNum);
players.forEach(p => {
list.innerHTML += `<div class="player-item"><span class="item-name">ğŸ•µï¸â€â™‚ï¸ ${p.name}</span></div>`;
});
document.getElementById('player-count').innerText = players.length;
if(isHost && players.length > 0 && answeredCount === players.length) checkAndFinish();
});

onSnapshot(doc(db, "rooms", roomId), (d) => {
const data = d.data(); if(!data) return;
if(data.status === "started") {
    const updatedMe = data.finalPlayers.find(p => p.name === myProfile.name);
    if(updatedMe) myProfile = updatedMe; 
    players = data.finalPlayers; 
    startGame(data);
}
if(data.status === "finished") showResults(data);
if(data.endTime) updateTimer(data.endTime);
});
}

async function checkAndFinish() {
const roomRef = doc(db, "rooms", myRoomId);
const snap = await getDoc(roomRef);
if(snap.exists() && snap.data().status === "started") await updateDoc(roomRef, { status: "finished" });
}

function checkAlibi(player, rangeStart, rangeEnd) {
    if (player.alibi === "ã‚¢ãƒªãƒã‚¤ç„¡ã—") return false;
    if (rangeStart === "AM" && player.alibi === "åˆå‰") return true;
    if (rangeStart === "PM" && player.alibi === "åˆå¾Œ") return true;
    if (player.alibi.includes("ã€œ")) {
        const parts = player.alibi.split("ï¼š");
        const start = parseInt(parts[0]);
        const end = parseInt(parts[1].split("ã€œ")[1]);
        return (start < rangeEnd && end > rangeStart);
    }
    return false;
}

function getAllPossibleHints(culprit, allPlayers, crimeTime) {
    const hints = [];
    const crimeH = parseInt(crimeTime.split(":")[0]);
    const lastN = culprit.lastName;
    const firstN = culprit.firstName;
    const fullN = culprit.fullName;

    const rawHints = [
        { label: `çŠ¯äººã®ä¸Šã®åå‰ã¯${lastN.length}æ–‡å­—ã§ã‚ã‚‹ã€‚`, fn: p => p.lastName.length === lastN.length, category: 1 },
        { label: `çŠ¯äººã®ä¸‹ã®åå‰ã¯${firstN.length}æ–‡å­—ã§ã‚ã‚‹ã€‚`, fn: p => p.firstName.length === firstN.length, category: 1 },
        { label: `çŠ¯äººã®å§“åã‚’åˆã‚ã›ã‚‹ã¨${fullN.length}æ–‡å­—ã§ã‚ã‚‹ã€‚`, fn: p => p.fullName.length === fullN.length, category: 1 },
        { label: `çŠ¯äººã®åå‰ã¯${fullN.length}æ–‡å­—ä»¥ä¸‹ã§ã‚ã‚‹ã€‚`, fn: p => p.fullName.length <= fullN.length, category: 1 }
    ];

    const rows = { "ã‚è¡Œ": /[ã‚ã„ã†ãˆãŠ]/, "ã‹è¡Œ": /[ã‹ããã‘ã“ãŒããã’ã”]/, "ã•è¡Œ": /[ã•ã—ã™ã›ãã–ã˜ãšãœã]/, "ãŸè¡Œ": /[ãŸã¡ã¤ã¦ã¨ã ã¢ã¥ã§ã©]/, "ãªè¡Œ": /[ãªã«ã¬ã­ã®]/, "ã¯è¡Œ": /[ã¯ã²ãµã¸ã»ã°ã³ã¶ã¹ã¼ã±ã´ã·ãºã½]/, "ã¾è¡Œ": /[ã¾ã¿ã‚€ã‚ã‚‚]/, "ã‚„è¡Œ": /[ã‚„ã‚†ã‚ˆ]/, "ã‚‰è¡Œ": /[ã‚‰ã‚Šã‚‹ã‚Œã‚]/ };
    Object.keys(rows).forEach(row => {
        const has = rows[row].test(fullN);
        rawHints.push({ label: `çŠ¯äººã®åå‰ã«ã€Œ${row}ã€ã®æ–‡å­—ãŒ${has ? 'å«ã¾ã‚Œã¦ã„ã‚‹' : 'å«ã¾ã‚Œãªã„'}ã€‚`, fn: p => rows[row].test(p.fullName) === has, category: 1 });
    });

    [2, 3, 5].forEach(n => {
        const isTarget = (culprit.idNum % n === 0);
        rawHints.push({ label: `çŠ¯äººã®å‡ºå¸­ç•ªå·ã¯${n}ã®å€æ•°ã§${isTarget ? 'ã‚ã‚‹' : 'ãªã„'}ã€‚`, fn: p => (p.idNum % n === 0) === isTarget, category: 1 });
    });
    rawHints.push({ label: `çŠ¯äººã®èª•ç”Ÿæœˆã¯${culprit.m % 2 === 0 ? 'å¶æ•°' : 'å¥‡æ•°'}ã§ã‚ã‚‹ã€‚`, fn: p => (p.m % 2 === 0) === (culprit.m % 2 === 0), category: 1 });
    rawHints.push({ label: `çŠ¯äººã®èª•ç”Ÿæ—¥ã®1ã®ä½ã¯${culprit.d % 10}ã§ã‚ã‚‹ã€‚`, fn: p => (p.d % 10) === (culprit.d % 10), category: 1 });

    rawHints.push({ label: `æœã¨é´ä¸‹ã®è‰²ãŒ${culprit.cloth === culprit.socks ? 'åŒã˜' : 'é•ã†'}ã§ã‚ã‚‹ã€‚`, fn: p => (p.cloth === p.socks) === (culprit.cloth === culprit.socks), category: 2 });
    rawHints.push({ label: `çŠ¯äººã®ã‚ºãƒœãƒ³ã®è‰²ã¯ã€Œ${culprit.pants}ã€ã ã€‚`, fn: p => p.pants === culprit.pants, category: 2 });
    rawHints.push({ label: `çŠ¯äººã®é´ä¸‹ã®è‰²ã¯ã€Œ${culprit.socks}ã€ã ã€‚`, fn: p => p.socks === culprit.socks, category: 2 });
    rawHints.push({ label: `èº«ã«ã¤ã‘ã¦ã„ã‚‹ã‚‚ã®ã®ä¸­ã«ã€Œ${culprit.cloth}ã€ãŒ1ã¤ä»¥ä¸Šã‚ã‚‹ã€‚`, fn: p => (p.cloth === culprit.cloth || p.pants === culprit.cloth || p.socks === culprit.cloth), category: 2 });
    
    const itemIcons = { "ğŸ": "ã‚Šã‚“ã”", "âš½": "ã‚µãƒƒã‚«ãƒ¼ãƒœãƒ¼ãƒ«", "ğŸ’": "ã»ã†ã›ã", "ğŸ‘“": "ã‚ãŒã­", "ğŸ®": "ã‚²ãƒ¼ãƒ ", "âŒš": "ã¨ã‘ã„", "ğŸ§": "ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³", "ğŸ€": "ãƒªãƒœãƒ³", "ğŸ“·": "ã‚«ãƒ¡ãƒ©" };
    Object.keys(itemIcons).forEach(icon => {
        const has = culprit.items.includes(icon);
        rawHints.push({ label: `çŠ¯äººã¯ã€Œ${icon}${itemIcons[icon]}ã€ã‚’${has ? 'ã‚‚ã£ã¦ã„ã‚‹' : 'ã‚‚ã£ã¦ã„ãªã„'}ã€‚`, fn: p => p.items.includes(icon) === has, category: 2 });
    });

    rawHints.push({ label: `çŠ¯è¡Œæ™‚åˆ»ã¯${crimeH < 12 ? 'åˆå‰' : 'åˆå¾Œ'}ã ã€‚`, fn: p => !checkAlibi(p, (crimeH < 12 ? "AM" : "PM"), null), category: 3 });
    rawHints.push({ label: `çŠ¯è¡Œæ™‚åˆ»ã¯${crimeH}ï¼š00ã€œ${crimeH + 1}ï¼š00ã®é–“ã«ãŠã“ãªã‚ã‚ŒãŸã€‚`, fn: p => !checkAlibi(p, crimeH, crimeH + 1), category: 3 });
    rawHints.push({ label: `çŠ¯è¡Œæ™‚åˆ»ã¯${crimeH - 1}ï¼š00ã€œ${crimeH + 1}ï¼š00ã®é–“ã«ãŠã“ãªã‚ã‚ŒãŸã€‚`, fn: p => !checkAlibi(p, crimeH - 1, crimeH + 1), category: 3 });
    
    rawHints.forEach(h => {
        const matchingPlayers = allPlayers.filter(p => h.fn(p));
        if (matchingPlayers.length >= 2 && matchingPlayers.length < allPlayers.length) {
            hints.push(h);
        }
    });

    if (hints.length === 0) {
        hints.push({ label: "çŠ¯äººã¯ã“ã®åç°¿ã®ä¸­ã«ã„ã‚‹ã‚ˆã†ã ã€‚", fn: p => true, category: 1 });
    }
    
    return hints;
}

function generateDynamicHints(culprit, allPlayers, crimeTime) {
    const total = allPlayers.length;
    const allHints = getAllPossibleHints(culprit, allPlayers, crimeTime);
    let finalHints = [];
    let usedLabels = new Set();
    let attempts = 0;
    while (attempts < 200) {
        const h1 = allHints.filter(h => h.category === 1).sort(() => Math.random() - 0.5)[0];
        const h2 = allHints.filter(h => h.category === 2).sort(() => Math.random() - 0.5)[0];
        const h3 = allHints.filter(h => h.category === 3).sort(() => Math.random() - 0.5)[0];
        if (!h1 || !h2 || !h3) { attempts++; continue; }
        const suspects = allPlayers.filter(p => h1.fn(p) && h2.fn(p) && h3.fn(p));
        if (suspects.length === 1 && suspects[0].name === culprit.name) {
            finalHints = [h1.label, h2.label, h3.label];
            usedLabels.add(h1.label); usedLabels.add(h2.label); usedLabels.add(h3.label);
            break;
        }
        attempts++;
    }
    let catCounter = 0;
    const categories = [1, 2, 3];
    while (finalHints.length < total) {
        const targetCat = categories[catCounter % 3];
        const candidates = allHints.filter(h => h.category === targetCat && !usedLabels.has(h.label));
        let added = false;
        for (let cand of candidates.sort(() => Math.random() - 0.5)) {
            const matchCount = allPlayers.filter(p => cand.fn(p)).length;
            if (matchCount > 1 && matchCount < allPlayers.length) {
                finalHints.push(cand.label);
                usedLabels.add(cand.label);
                added = true;
                break;
            }
        }
        if (!added) {
            const innocent = allPlayers.filter(p => p.name !== culprit.name).sort(() => Math.random() - 0.5)[0];
            finalHints.push(`${innocent.name} ã•ã‚“ã¯çŠ¯äººã˜ã‚ƒãªã„ã€‚`);
        }
        catCounter++;
    }
    return finalHints.sort(() => Math.random() - 0.5);
}

document.getElementById('start-game-btn').onclick = async () => {
    if(players.length < 2) { alert("2äººä»¥ä¸Šå¿…è¦ã§ã™"); return; }
    const hours = [8, 9, 10, 11, 12, 13, 14];
    const selectedHour = hours[Math.floor(Math.random() * hours.length)];
    const crimeTimeStr = `${selectedHour}:00`;

    const assignBalancedColorsAndAlibi = (playerList) => {
        const categories = ['cloth', 'pants', 'socks'];
        const numPlayers = playerList.length;
        const itemIcons = ["ğŸ‘“", "âŒš", "ğŸ§", "ğŸ€", "ğŸ“·", "ğŸ", "âš½", "ğŸ’", "ğŸ”‘"];
        categories.forEach(cat => {
            let colorPool = [];
            for (let i = 0; i < numPlayers; i++) colorPool.push(colors[i % colors.length]);
            colorPool.sort(() => Math.random() - 0.5);
            playerList.forEach((p, idx) => { p[cat] = colorPool[idx]; });
        });
        playerList.forEach(p => {
            p.items = [...itemIcons].sort(() => Math.random() - 0.5).slice(0, 3).join(" ");
            const alibiTypes = ["4h", "5h", "6h", "AM", "PM", "none"];
            const type = alibiTypes[Math.floor(Math.random() * alibiTypes.length)];
            if (type === "none") p.alibi = "ã‚¢ãƒªãƒã‚¤ç„¡ã—";
            else if (type === "AM") p.alibi = "åˆå‰";
            else if (type === "PM") p.alibi = "åˆå¾Œ";
            else {
                const duration = parseInt(type);
                let start = 8 + Math.floor(Math.random() * (15 - 8 - duration + 1));
                p.alibi = `${start}ï¼š00ã€œ${start + duration}ï¼š00`;
            }
        });
        const culpritObj = playerList[Math.floor(Math.random() * numPlayers)];
        culpritObj.isCulprit = true;
        let isOverlapping = false;
        const crimeH = selectedHour;
        if (culpritObj.alibi === "åˆå‰" && crimeH < 12) isOverlapping = true;
        if (culpritObj.alibi === "åˆå¾Œ" && crimeH >= 12) isOverlapping = true;
        if (culpritObj.alibi.includes("ã€œ")) {
            const parts = culpritObj.alibi.split("ï¼š");
            const start = parseInt(parts[0]);
            const end = parseInt(parts[1].split("ã€œ")[1]);
            if (crimeH >= start && crimeH < end) isOverlapping = true;
        }
        if (isOverlapping) culpritObj.alibi = "ã‚¢ãƒªãƒã‚¤ç„¡ã—";
        return { list: playerList, culprit: culpritObj };
    };

    const { list: finalPlayers, culprit } = assignBalancedColorsAndAlibi([...players]);
    const incident = incidentData[Math.floor(Math.random() * incidentData.length)];
    const duration = parseInt(document.getElementById('game-duration').value);
    const endTime = Date.now() + (duration * 60 * 1000);
    const assignedHints = generateDynamicHints(culprit, finalPlayers, crimeTimeStr);

    await updateDoc(doc(db, "rooms", myRoomId), {
        status: "started", 
        culpritName: culprit.name, 
        incident: incident.title, 
        detail: incident.detail,
        endTime: endTime, 
        hints: assignedHints,
        finalPlayers: finalPlayers,
        crimeTime: crimeTimeStr
    });
};

function updateTimer(endTime) {
    const display = document.getElementById('timer-display');
    document.getElementById('game-timer').classList.remove('hidden');
    const interval = setInterval(async () => {
        const remaining = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
        display.innerText = `æ®‹ã‚Š ${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,'0')}`;
        if(remaining <= 0) { clearInterval(interval); if(isHost) checkAndFinish(); }
    }, 1000);
}

let gameStartedLocally = false;
async function startGame(data) {
    if(gameStartedLocally) return;
    gameStartedLocally = true;
    const overlay = document.getElementById('event-overlay');
    const typeBox = document.getElementById('event-typewriter');
    const titleDisp = document.getElementById('event-title-display');
    overlay.classList.remove('hidden');
    await runTypewriter(typeBox, "æ¢åµäº‹å‹™æ‰€ã«èª¿æŸ»ä¾é ¼ãŒå±Šãã¾ã—ãŸ...\n\n" + data.detail, 80);
    await robustWait(2000);
    titleDisp.innerText = "ã€" + data.incident + "ã€‘";
    titleDisp.classList.add('stamp-anim');
    await robustWait(2000);
    overlay.classList.add('hidden');
    document.getElementById('lobby-screen').classList.add('hidden');
    document.getElementById('game-screen').classList.remove('hidden');
    document.getElementById('incident-text').innerText = data.incident;
    const myIndex = players.findIndex(p => p.name === myProfile.name);
    document.getElementById('my-hint').innerText = data.hints[myIndex] || "æœ‰åŠ›ãªæƒ…å ±ã‚’å¾—ã‚‰ã‚Œãªã‹ã£ãŸ...";
    
    const listContainer = document.getElementById('investigation-list');
    listContainer.innerHTML = players.map((p, idx) =>
    `<div class="player-item" id="investigate-p-${idx}">
        <div class="item-info">
            <span class="item-name">${p.name}</span>
            <div class="item-details">
                <span class="list-cell">${p.idNum}ç•ª / ${p.m}æœˆ${p.d}æ—¥</span><span class="divider">/</span>
                <span class="list-cell">æœ:<span style="color:${getDisplayColor(p.cloth)};">${p.cloth}</span> ã‚ºãƒœãƒ³:<span style="color:${getDisplayColor(p.pants)};">${p.pants}</span> é´ä¸‹:<span style="color:${getDisplayColor(p.socks)};">${p.socks}</span></span><span class="divider">/</span>
                <span class="list-cell">æŒã¡ç‰©:${p.items}</span><span class="divider">/</span>
                <span class="list-cell" style="color:#4ecca3;">ã‚¢ãƒªãƒã‚¤:${p.alibi}</span>
            </div>
        </div>
        <div class="check-controls">
            <button class="check-btn" onclick="toggleStatus(${idx}, 'suspect')">â“ çŠ¯äººã‹ã‚‚</button>
            <button class="check-btn" onclick="toggleStatus(${idx}, 'safe')">âœ… çŠ¯äººã˜ã‚ƒãªã„</button>
            <button class="check-btn btn-reset" onclick="resetStatus(${idx})">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>`).join("");
}

window.toggleStatus = (idx, status) => {
    const row = document.getElementById(`investigate-p-${idx}`);
    row.classList.remove('status-suspect', 'status-safe');
    investigationStatus[idx] = status;
    if(status === 'suspect') row.classList.add('status-suspect');
    else if(status === 'safe') row.classList.add('status-safe');
};window.resetStatus = (idx) => {
    const row = document.getElementById(`investigate-p-${idx}`);
    row.classList.remove('status-suspect', 'status-safe');
    delete investigationStatus[idx];
};window.renderSuspectButtons = () => {
    const container = document.getElementById('suspect-list');
    container.innerHTML = "";
    players.forEach((p, idx) => {
        const isSafe = investigationStatus[idx] === 'safe';
        const btn = document.createElement('button');
        btn.style.opacity = isSafe ? "0.5" : "1";
        btn.style.background = isSafe ? "#333" : "#a6894a";
        btn.style.color = isSafe ? "#888" : "#1a2e22";
        btn.innerHTML = `ğŸ•µï¸â€â™‚ï¸ ${p.name} ${isSafe ? '(ã‚·ãƒ­åˆ¤å®šä¸­)' : ''}`;
        btn.onclick = () => submitAnswer(p.name);
        container.appendChild(btn);
    });
};document.getElementById('btn-solve-open').onclick = () => switchTab('solve-screen');async function submitAnswer(name) {
    if(!confirm(`${name} ãŒçŠ¯äººã§é–“é•ã„ãªã„ã§ã™ã‹ï¼Ÿ`)) return;
    hasAnswered = true;
    document.getElementById('btn-solve-open').classList.add('hidden');
    document.getElementById('answered-status').classList.remove('hidden');
    await updateDoc(doc(db, "rooms", myRoomId, "players", myProfile.name), {
        answer: name,
        answerTime: Date.now()
    });
    switchTab('tab-hint');
}async function showResults(data) {
    const overlay = document.getElementById('event-overlay');
    const typeBox = document.getElementById('event-typewriter');
    const titleDisp = document.getElementById('event-title-display');
    const playerSnaps = await getDocs(collection(db, "rooms", myRoomId, "players"));
    let winners = [];
    playerSnaps.forEach(p => { 
        const pData = p.data();
        if(pData.answer === data.culpritName) winners.push(pData); 
    });
    winners.sort((a, b) => (a.answerTime || 9999999999999) - (b.answerTime || 9999999999999));
    overlay.classList.remove('hidden');
    titleDisp.classList.remove('stamp-anim');
    titleDisp.innerText = "";
    let msg = winners.length > 0 
        ? `åæ¢åµã®ã€Œ${winners[0].name}ã€ã•ã‚“ãŒçœŸå®Ÿã«ãŸã©ã‚Šç€ãã€æ•™å®¤ã«ã¿ã‚“ãªã‚’é›†ã‚ãŸâ€¦â€¦ã€‚\n\nãã®å†…ã®ï¼‘äººã‚’æŒ‡å·®ã—ã¦ã€çŠ¯äººã®åå‰ã‚’å«ã‚“ã ï¼\n\nã€Œã“ã®äº‹ä»¶ã®çŠ¯äººã¯ã‚ãªãŸã§ã™ï¼ã€`
        : "çŠ¯äººã¯é€ƒã’åˆ‡ã£ã¦ã—ã¾ã£ãŸã‚ˆã†ã â€¦ã€‚\næ”¾èª²å¾Œã€ã¿ã‚“ãªãŒå¸°ã£ãŸæ•™å®¤ã§ã€å…ˆç”ŸãŒé™ã‹ã«å£ã‚’ã²ã‚‰ã„ãŸâ€¦\n\nã€Œã¾ã•ã‹ã€ã‚ãªãŸãŒçŠ¯äººã ã£ãŸãªã‚“ã¦â€¦ã€";
    await runTypewriter(typeBox, msg, 80);
    await robustWait(2000);
    titleDisp.innerText = `${data.culpritName} ã•ã‚“`;
    titleDisp.classList.add('stamp-anim');
    await robustWait(2000);
    overlay.classList.add('hidden');
    document.getElementById('game-screen').classList.add('hidden');
    document.getElementById('result-screen').classList.remove('hidden');
    document.getElementById('result-incident-title').innerText = "ã€" + data.incident + "ã€‘";
    document.getElementById('culprit-reveal').innerText = data.culpritName;
    const wList = document.getElementById('winner-list');
    wList.innerHTML = winners.length > 0 
        ? winners.map(w => `<span class="winner-tag">ğŸ† ${w.name}</span>`).join("")
        : "<p style='color:#888;'>æ­£è§£è€…ã¯ã„ã¾ã›ã‚“ã§ã—ãŸâ€¦</p>";
}setTimeout(loadProfile, 100);</script></body></html>