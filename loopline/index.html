<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§é˜ªç’°çŠ¶ç·šã‚¿ã‚¤ãƒ”ãƒ³ã‚° - é§…åã‚’å…¥åŠ›ã—ã¦é›»è»Šã‚’åŠ é€Ÿã•ã›ã‚ˆã†ï¼</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --loop-orange: #f39700;
        }

        body {
            background-color: #f0f0f0;
            color: #333;
            font-family: 'Noto Sans JP', sans-serif;
            overflow: hidden;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        #viewport-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .game-panel {
            background: #ffffff;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            position: relative;
            width: 900px;
            height: 850px;
            display: flex;
            flex-direction: column;
            transform-origin: center center;
            flex-shrink: 0;
        }

        .title-main {
            white-space: nowrap;
            overflow: visible;
        }

        .railway-map {
            position: relative;
            width: 600px;
            height: 600px;
            border: 28px solid var(--loop-orange);
            border-radius: 50%;
            margin: auto;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }

        .center-display {
            text-align: center;
            z-index: 10;
            width: 90%;
        }

        .map-element {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .train-icon {
            width: 80px;
            height: 80px;
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: margin 0.1s linear;
        }

        .train-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
        }

        .station-dot {
            width: 20px;
            height: 20px;
            background-color: #fff;
            border: 3px solid #333;
            border-radius: 50%;
            z-index: 35;
        }

        .char-next { color: #ccc; }
        .char-correct { color: var(--loop-orange); }
        .char-current {
            color: #333;
            text-decoration: underline;
            animation: blink 0.8s infinite;
        }

        @keyframes blink {
            50% { opacity: 0.4; }
        }

        .miss-flash {
            color: #ef4444 !important;
            animation: shake 0.2s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .time-bar-container {
            width: 100%;
            height: 12px;
            background: #eee;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        #station-timer-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--loop-orange);
            will-change: width;
        }

        .overlay {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
        }

        .total-fare-area {
            background: rgba(0, 0, 0, 0.05);
            padding: 10px 20px;
            border-radius: 12px;
            display: inline-block;
            margin-top: 10px;
        }

        .total-fare-value {
            font-size: 32px;
            font-weight: 900;
            display: baseline;
            justify-content: center;
        }

        .fare-num-wrapper {
            position: relative;
            display: inline-block;
            text-align: right;
            min-width: 4.5ch;
        }

        .fare-unit {
            font-size: 18px;
            margin-left: 4px;
        }

        .ticket-style {
            background: #fdf5e6;
            color: #5d4a3b;
            border: 1px solid #d2b48c;
            padding: 15px;
            position: relative;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.1);
            max-width: 380px;
            margin-left: auto;
            margin-right: auto;
        }

        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 0.1em;
        }

        .time-select-btn {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 0.8rem;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .time-select-btn.active {
            background: white;
            color: #ea580c;
            border-color: #ea580c;
        }

        .best-score-badge {
            background: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 900;
            padding: 4px 12px;
            border-radius: 999px;
            display: inline-block;
            margin-top: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .footer-credit {
            position: absolute;
            bottom: 12px;
            width: 100%;
            text-align: center;
            font-size: 10px;
            color: #9ca3af;
            letter-spacing: 0.05em;
            pointer-events: none;
            opacity: 0.7;
        }
    </style>
</head>
<body>

    <div id="viewport-wrapper">
        <div id="game-container" class="game-panel rounded-3xl p-8 overflow-hidden">
            
            <div class="flex justify-between items-center mb-4">
                <div class="text-3xl font-black text-orange-600">
                    <span id="timer">60ç§’</span>
                </div>
                <div class="text-xl font-bold text-gray-500">
                    <span id="score">0å‘¨ / 0é§…</span>
                </div>
            </div>

            <div class="flex-grow flex items-center justify-center relative">
                <div class="railway-map" id="map-circle">
                    <div class="center-display">
                        <div id="ruby" class="text-2xl text-gray-400 mb-2 font-bold tracking-widest">ãŠãŠã•ã‹</div>
                        <div id="kanji" class="text-8xl font-black mb-8 tracking-tighter text-gray-800">å¤§é˜ª</div>
                        <div id="romaji-display" class="text-5xl font-mono uppercase tracking-widest h-14 font-bold"></div>
                    </div>
                    <div id="train" class="map-element train-icon">
                        <img src="001.png" alt="ğŸšƒ">
                    </div>
                </div>
            </div>

            <div class="mt-6 mb-4">
                <div class="flex justify-between text-sm text-gray-400 mb-2 font-bold uppercase tracking-widest">
                    <span>æ¬¡ã®é§…ã¾ã§â€¦</span>
                    <span id="station-timer-text">10.0ç§’</span>
                </div>
                <div class="time-bar-container">
                    <div id="station-timer-bar"></div>
                </div>
            </div>

            <div class="footer-credit">
                å¤§é˜ªç’°çŠ¶ç·šã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã€€|ã€€ver.1.27ã€€|ã€€ota tools
            </div>

            <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
            <div id="start-overlay" class="absolute inset-0 flex items-center justify-center bg-orange-500 z-50">
                <div class="text-center text-white p-6 w-full max-w-lg relative h-full flex flex-col justify-center">
                    <h1 class="text-5xl font-black mb-2 italic title-main">å¤§é˜ªç’°çŠ¶ç·šã‚¿ã‚¤ãƒ”ãƒ³ã‚°</h1>
                    <h2 class="text-2xl font-bold mb-6">é§…åã‚’å…¥åŠ›ã—ã¦é›»è»Šã‚’åŠ é€Ÿã•ã›ã‚ˆã†ï¼</h2>
                    
                    <div class="mb-8">
                        <p class="text-sm font-bold mb-3">ä¹—è»Šæ™‚é–“ã‚’é¸æŠ</p>
                        <div class="flex justify-center gap-2">
                            <button onclick="changeTimeLimit(60)" id="btn-60" class="time-select-btn active">60ç§’</button>
                            <button onclick="changeTimeLimit(90)" id="btn-90" class="time-select-btn">90ç§’</button>
                            <button onclick="changeTimeLimit(120)" id="btn-120" class="time-select-btn">120ç§’</button>
                        </div>
                    </div>

                    <div class="flex gap-4 justify-center mb-6">
                        <button onclick="prepareGame('inner')" class="bg-white text-blue-600 font-bold py-6 px-4 rounded-2xl hover:scale-105 transition shadow-xl w-1/2">
                            <span class="block text-3xl mb-1">å†…å›ã‚Š</span>
                            <span class="text-[10px] font-normal block mb-2 opacity-70">å¤§é˜ªâ†’ç¦å³¶ ã»ã†ã‚ã‚“</span>
                            <div class="best-score-badge text-blue-700">
                                ãƒ™ã‚¹ãƒˆ: <span id="best-inner">0å‘¨ 0é§…</span>
                            </div>
                        </button>
                        
                        <button onclick="prepareGame('outer')" class="bg-white text-orange-600 font-bold py-6 px-4 rounded-2xl hover:scale-105 transition shadow-xl w-1/2">
                            <span class="block text-3xl mb-1">å¤–å›ã‚Š</span>
                            <span class="text-[10px] font-normal block mb-2 opacity-70">å¤§é˜ªâ†’å¤©æº€ ã»ã†ã‚ã‚“</span>
                            <div class="best-score-badge text-orange-700">
                                ãƒ™ã‚¹ãƒˆ: <span id="best-outer">0å‘¨ 0é§…</span>
                            </div>
                        </button>
                    </div>

                    <div class="total-fare-area">
                        <span class="total-fare-label">ä½¿ã£ãŸãŠé‡‘</span>
                        <div class="total-fare-value">
                            <span class="fare-num-wrapper">
                                <span id="total-fare-all">0</span>
                            </span>
                            <span class="fare-unit">å††</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ -->
            <div id="ready-overlay" class="absolute inset-0 hidden flex items-center justify-center overlay z-[60] bg-black/80">
                <div class="text-center text-white">
                    <div class="text-3xl font-bold mb-8 animate-pulse">ç™ºè»Šæº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ</div>
                    <div class="bg-white text-black px-8 py-6 rounded-2xl shadow-2xl">
                        <div class="text-lg font-bold mb-2">ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ã­</div>
                        <div class="text-4xl font-black border-4 border-black py-2 rounded-lg">SPACE</div>
                    </div>
                    <div class="mt-8 text-orange-400 font-bold tracking-widest" id="ready-info"></div>
                </div>
            </div>

            <!-- ãƒªã‚¶ãƒ«ãƒˆ -->
            <div id="result-overlay" class="absolute inset-0 hidden flex items-center justify-center overlay z-50 p-6">
                <div class="text-center w-full max-w-md mx-auto">
                    <div id="result-title" class="mb-6 text-2xl tracking-widest text-gray-800 border-b-4 border-orange-500 pb-2 font-black">ã”ä¹—è»Šã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</div>
                    <div class="bg-gray-800 text-white p-6 rounded-2xl mb-6 shadow-xl">
                        <div class="flex justify-between text-4xl mb-6 items-end">
                            <span class="text-base opacity-50 font-bold mb-1">ãã†ã“ã†ãã‚‡ã‚Š</span>
                            <span><span id="final-laps">0</span>å‘¨ <span id="final-stations">0</span>é§…</span>
                        </div>
                        <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm pt-4 border-t border-gray-700">
                            <div class="flex justify-between"><span>æ­£è§£:</span><span id="stat-correct">0</span></div>
                            <div class="flex justify-between"><span>ãƒŸã‚¹:</span><span id="stat-miss" class="text-red-400">0</span></div>
                            <div class="flex justify-between"><span>ã‚¹ãƒ”ãƒ¼ãƒ‰:</span><span><span id="stat-wpm">0</span> WPM</span></div>
                            <div class="flex justify-between"><span>è‹¦æ‰‹ã‚­ãƒ¼:</span><span id="stat-weak" class="text-red-400">-</span></div>
                        </div>
                    </div>
                    <div id="ticket-area" class="ticket-style mb-8 shadow-xl rounded-sm">
                        <div id="ticket-header" class="flex justify-between text-[10px] mb-4 border-b border-[#d2b48c] pb-1"><span>JRè¥¿æ—¥æœ¬</span><span>å¤§é˜ªç’°çŠ¶ç·š</span></div>
                        <div id="ticket-main-content" class="flex items-center justify-center gap-6 py-2">
                            <div class="flex items-center gap-4">
                                <div id="from-station" class="text-2xl font-bold border-2 border-[#5d4a3b] p-1 vertical-text">å¤§é˜ª</div>
                                <div class="text-xl font-bold">â–¶</div>
                            </div>
                            <div class="text-center">
                                <div class="text-6xl font-black mb-1"><span id="fare">0</span>å††</div>
                                <div class="text-lg font-bold border-t border-[#5d4a3b] pt-1 mt-1">å°å…<span id="fare-child">0</span>å††</div>
                            </div>
                        </div>
                        <div class="text-[9px] mt-4 flex justify-between opacity-70"><span id="ticket-date"></span><span>å®Ÿéš›ã®é‹è³ƒã¨ã¯ç•°ãªã‚Šã¾ã™</span></div>
                    </div>
                    <button onclick="location.reload()" class="w-full bg-orange-600 text-white font-black py-5 rounded-2xl text-xl hover:bg-orange-700 transition shadow-lg">ã‚‚ã†ã„ã¡ã©ä¹—ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ROMAJI_TABLE = {
            'ã‚':['a'], 'ã„':['i'], 'ã†':['u'], 'ãˆ':['e'], 'ãŠ':['o'],
            'ã‹':['ka'], 'ã':['ki'], 'ã':['ku'], 'ã‘':['ke'], 'ã“':['ko'],
            'ã•':['sa'], 'ã—':['si','shi'], 'ã™':['su'], 'ã›':['se'], 'ã':['so'],
            'ãŸ':['ta'], 'ã¡':['ti','chi'], 'ã¤':['tu','tsu'], 'ã¦':['te'], 'ã¨':['to'],
            'ãª':['na'], 'ã«':['ni'], 'ã¬':['nu'], 'ã­':['ne'], 'ã®':['no'],
            'ã¯':['ha'], 'ã²':['hi'], 'ãµ':['hu','fu'], 'ã¸':['he'], 'ã»':['ho'],
            'ã¾':['ma'], 'ã¿':['mi'], 'ã‚€':['mu'], 'ã‚':['me'], 'ã‚‚':['mo'],
            'ã‚„':['ya'], 'ã‚†':['yu'], 'ã‚ˆ':['yo'],
            'ã‚‰':['ra'], 'ã‚Š':['ri'], 'ã‚‹':['ru'], 'ã‚Œ':['re'], 'ã‚':['ro'],
            'ã‚':['wa'], 'ã‚’':['wo'], 'ã‚“':['n','nn'],
            'ãŒ':['ga'], 'ã':['gi'], 'ã':['gu'], 'ã’':['ge'], 'ã”':['go'],
            'ã–':['za'], 'ã˜':['zi','ji'], 'ãš':['zu'], 'ãœ':['ze'], 'ã':['zo'],
            'ã ':['da'], 'ã¢':['di'], 'ã¥':['du'], 'ã§':['de'], 'ã©':['do'],
            'ã°':['ba'], 'ã³':['bi'], 'ã¶':['bu'], 'ã¹':['be'], 'ã¼':['bo'],
            'ã±':['pa'], 'ã´':['pi'], 'ã·':['pu'], 'ãº':['pe'], 'ã½':['po'],
            'ãã‚ƒ':['kya'], 'ãã‚…':['kyu'], 'ãã‚‡':['kyo'],
            'ã—ã‚ƒ':['sya','sha'], 'ã—ã‚…':['syu','shu'], 'ã—ã‚‡':['syo','sho'],
            'ã¡ã‚ƒ':['tya','cha'], 'ã¡ã‚…':['tyu','chu'], 'ã¡ã‚‡':['tyo','cho'],
            'ã«ã‚ƒ':['nya'], 'ã«ã‚…':['nyu'], 'ã«ã‚‡':['nyo'],
            'ã²ã‚ƒ':['hya'], 'ã²ã‚…':['hyu'], 'ã²ã‚‡':['hyo'],
            'ã¿ã‚ƒ':['mya'], 'ã¿ã‚…':['myu'], 'ã¿ã‚‡':['myo'],
            'ã‚Šã‚ƒ':['rya'], 'ã‚Šã‚…':['ryo'], 'ã‚Šã‚‡':['ryo'],
            'ãã‚ƒ':['gya'], 'ãã‚…':['gyu'], 'ãã‚‡':['gyo'],
            'ã˜ã‚ƒ':['zya','ja'], 'ã˜ã‚…':['zyu','ju'], 'ã˜ã‚‡':['zyo','jo'],
            'ã³ã‚ƒ':['bya'], 'ã³ã‚…':['byu'], 'ã³ã‚‡':['byo'],
            'ã´ã‚ƒ':['pya'], 'ã´ã‚…':['pu'], 'ã´ã‚‡':['pyo'],
            'ã£':['xtu','ltu','ltsu'],
            'ã':['xa','la'], 'ãƒ':['xi','li'], 'ã…':['xu','lu'], 'ã‡':['xe','le'], 'ã‰':['xo','lo'],
            'ã‚ƒ':['xya','lya'], 'ã‚…':['xyu','lyu'], 'ã‚‡':['xyo','lyo'],
            'ãƒ¼':['-']
        };

        const STATIONS_MASTER = [
            { kanji: "å¤§é˜ª", ruby: "ãŠãŠã•ã‹" },
            { kanji: "å¤©æº€", ruby: "ã¦ã‚“ã¾" },
            { kanji: "æ¡œãƒå®®", ruby: "ã•ãã‚‰ã®ã¿ã‚„" },
            { kanji: "äº¬æ©‹", ruby: "ãã‚‡ã†ã°ã—" },
            { kanji: "å¤§é˜ªåŸå…¬åœ’", ruby: "ãŠãŠã•ã‹ã˜ã‚‡ã†ã“ã†ãˆã‚“" },
            { kanji: "æ£®ãƒå®®", ruby: "ã‚‚ã‚Šã®ã¿ã‚„" },
            { kanji: "ç‰é€ ", ruby: "ãŸã¾ã¤ãã‚Š" },
            { kanji: "é¶´æ©‹", ruby: "ã¤ã‚‹ã¯ã—" },
            { kanji: "æ¡ƒè°·", ruby: "ã‚‚ã‚‚ã ã«" },
            { kanji: "å¯ºç”°ç”º", ruby: "ã¦ã‚‰ã ã¡ã‚‡ã†" },
            { kanji: "å¤©ç‹å¯º", ruby: "ã¦ã‚“ã®ã†ã˜" },
            { kanji: "æ–°ä»Šå®®", ruby: "ã—ã‚“ã„ã¾ã¿ã‚„" },
            { kanji: "ä»Šå®®", ruby: "ã„ã¾ã¿ã‚„" },
            { kanji: "èŠ¦åŸæ©‹", ruby: "ã‚ã—ã¯ã‚‰ã°ã—" },
            { kanji: "å¤§æ­£", ruby: "ãŸã„ã—ã‚‡ã†" },
            { kanji: "å¼å¤©ç”º", ruby: "ã¹ã‚“ã¦ã‚“ã¡ã‚‡ã†" },
            { kanji: "è¥¿ä¹æ¡", ruby: "ã«ã—ãã˜ã‚‡ã†" },
            { kanji: "é‡ç”°", ruby: "ã®ã " },
            { kanji: "ç¦å³¶", ruby: "ãµãã—ã¾" }
        ];

        let stations = [];
        let loopDirection = 'outer';
        let currentStationIndex = 0;
        let totalStationsCovered = 0; // é€šéã—ãŸé§…æ•°
        let timeLimit = 60; 
        let timeLeft = 60;
        let isPlaying = false;
        let isReady = false; 
        let isWaitingForNext = false;
        let correctCount = 0; // æ­£è§£ã‚¿ã‚¤ãƒ—æ•°
        let missCount = 0;
        let missedTargetKeys = {}; 
        
        const STATION_LIMIT_SEC = 10;
        let stationTimeRemaining = STATION_LIMIT_SEC;
        let stationTimerRequestId = null;
        let lastTimestamp = 0;

        let currentKanaList = [];
        let currentTargetIndex = 0;
        let currentTypedInChar = "";
        let confirmedRomajiList = [];

        function handleResize() {
            const container = document.getElementById('game-container');
            const w = window.innerWidth;
            const h = window.innerHeight;
            const baseW = 900, baseH = 850;
            const scale = Math.min(w / baseW, h / baseH, 1);
            container.style.transform = `scale(${scale})`;
            initMap();
        }

        function splitKana(text) {
            const result = [];
            let i = 0;
            while (i < text.length) {
                let char = text[i];
                let next = text[i+1];
                if (next && "ããƒã…ã‡ã‰ã‚ƒã‚…ã‚‡".includes(next)) {
                    result.push(char + next);
                    i += 2;
                } else {
                    result.push(char);
                    i++;
                }
            }
            return result;
        }

        function getMapMetrics() {
            const mapCircle = document.getElementById('map-circle');
            if (!mapCircle) return { radius: 250 };
            return { radius: (mapCircle.offsetWidth - 28) / 2 };
        }

        function initMap() {
            const metrics = getMapMetrics();
            const mapCircle = document.getElementById('map-circle');
            if (!mapCircle) return;
            mapCircle.querySelectorAll('.station-dot').forEach(d => d.remove());
            STATIONS_MASTER.forEach((_, i) => {
                const angle = (i / STATIONS_MASTER.length) * Math.PI * 2 - Math.PI / 2;
                const x = metrics.radius * Math.cos(angle);
                const y = metrics.radius * Math.sin(angle);
                const dot = document.createElement('div');
                dot.className = 'map-element station-dot';
                dot.style.marginLeft = `${x}px`;
                dot.style.marginTop = `${y}px`;
                mapCircle.appendChild(dot);
            });
            updateTrainPosition(0);
        }

        function updateTrainPosition(progress) {
            const train = document.getElementById('train');
            if (!train) return;
            const metrics = getMapMetrics();
            let currentIdx = currentStationIndex;
            let nextIdx = (currentStationIndex + 1) % STATIONS_MASTER.length;
            if (loopDirection === 'inner') {
                currentIdx = (STATIONS_MASTER.length - currentStationIndex) % STATIONS_MASTER.length;
                nextIdx = (STATIONS_MASTER.length - (currentStationIndex + 1)) % STATIONS_MASTER.length;
            }
            const startAngle = (currentIdx / STATIONS_MASTER.length) * Math.PI * 2 - Math.PI / 2;
            let endAngle = (nextIdx / STATIONS_MASTER.length) * Math.PI * 2 - Math.PI / 2;
            if (loopDirection === 'outer' && endAngle < startAngle) endAngle += Math.PI * 2;
            if (loopDirection === 'inner' && endAngle > startAngle) endAngle -= Math.PI * 2;
            const currentAngle = startAngle + (endAngle - startAngle) * progress;
            const x = metrics.radius * Math.cos(currentAngle);
            const y = metrics.radius * Math.sin(currentAngle);
            train.style.marginLeft = `${x}px`;
            train.style.marginTop = `${y}px`;
        }

        function changeTimeLimit(sec) {
            timeLimit = sec;
            timeLeft = sec;
            document.getElementById('timer').innerText = `${sec}ç§’`;
            [60, 90, 120].forEach(s => document.getElementById(`btn-${s}`).classList.toggle('active', s === sec));
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            const getBest = (dir) => {
                const val = localStorage.getItem(`best_${dir}_${timeLimit}`) || 0;
                return `${Math.floor(val / STATIONS_MASTER.length)}å‘¨ ${val % STATIONS_MASTER.length}é§…`;
            };
            document.getElementById('best-inner').innerText = getBest('inner');
            document.getElementById('best-outer').innerText = getBest('outer');
            document.getElementById('total-fare-all').innerText = parseInt(localStorage.getItem('total_fare_all_time') || 0).toLocaleString();
        }

        function prepareGame(direction) {
            loopDirection = direction;
            isReady = true;
            document.getElementById('ready-info').innerText = `${direction === 'inner' ? 'å†…å›ã‚Š' : 'å¤–å›ã‚Š'}ãƒ»${timeLimit}ç§’`;
            document.getElementById('ready-overlay').classList.remove('hidden');
        }

        function startGame() {
            isReady = false;
            document.getElementById('ready-overlay').classList.add('hidden');
            document.getElementById('start-overlay').style.display = 'none';
            stations = (loopDirection === 'outer') ? [...STATIONS_MASTER] : [STATIONS_MASTER[0], ...[...STATIONS_MASTER].slice(1).reverse()];
            isPlaying = true;
            isWaitingForNext = false;
            timeLeft = timeLimit;
            correctCount = 0; missCount = 0; missedTargetKeys = {}; 
            totalStationsCovered = 0; currentStationIndex = 0;
            initMap();
            updateStationDisplay();
            startMainTimer();
            lastTimestamp = performance.now();
            resetStationTimer();
        }

        function startMainTimer() {
            const id = setInterval(() => {
                if (!isPlaying) return clearInterval(id);
                timeLeft--;
                document.getElementById('timer').innerText = `${timeLeft}ç§’`;
                if (timeLeft <= 0) { clearInterval(id); endGame(); }
            }, 1000);
        }

        function calculateFare(covered) {
            // å¤§é˜ªç’°çŠ¶ç·šã®å¹³å‡é§…é–“ã‚’ç´„1kmã¨ã—ã¦æ“¬ä¼¼è¨ˆç®—
            const km = covered;
            let fare = 0;
            if (km <= 3) fare = 150;
            else if (km <= 6) fare = 190;
            else if (km <= 10) fare = 200;
            else if (km <= 15) fare = 240;
            else fare = 240 + Math.floor((km - 15) / 5) * 40; // 15kmè¶…ã®æš«å®š
            return fare;
        }

        function endGame() {
            isPlaying = false;
            if (stationTimerRequestId) cancelAnimationFrame(stationTimerRequestId);
            
            // èµ°è¡Œè·é›¢: å®Œäº†ã—ãŸé§… + æœ€å¾Œã®é§…ã®é€šéç‡ã‚’è¨ˆç®—
            const finalProgressRatio = (STATION_LIMIT_SEC - stationTimeRemaining) / STATION_LIMIT_SEC;
            const finalCovered = totalStationsCovered + (finalProgressRatio >= 0.99 ? 1 : 0);
            
            const currentFare = calculateFare(finalCovered);
            // å­ä¾›æ–™é‡‘: åŠé¡ã€5å††ä»¥ä¸‹ã¯åˆ‡ã‚Šæ¨ã¦ï¼ˆJRã®ãƒ«ãƒ¼ãƒ«: 10å††å˜ä½ã«åˆ‡ã‚Šæ¨ã¦ï¼‰
            const childFare = Math.floor((currentFare / 2) / 10) * 10;
            
            localStorage.setItem('total_fare_all_time', parseInt(localStorage.getItem('total_fare_all_time') || 0) + currentFare);
            
            const bestKey = `best_${loopDirection}_${timeLimit}`;
            if (finalCovered > parseInt(localStorage.getItem(bestKey) || 0)) localStorage.setItem(bestKey, finalCovered);
            
            document.getElementById('final-laps').innerText = Math.floor(finalCovered / STATIONS_MASTER.length);
            document.getElementById('final-stations').innerText = finalCovered % STATIONS_MASTER.length;
            document.getElementById('stat-correct').innerText = correctCount;
            document.getElementById('stat-miss').innerText = missCount;
            
            // WPMè¨ˆç®—: æ­£è§£ã‚¿ã‚¤ãƒ—æ•° Ã· è¨­å®šæ™‚é–“ Ã— 60
            const wpm = Math.round((correctCount / timeLimit) * 60);
            document.getElementById('stat-wpm').innerText = wpm;
            
            const sortedMiss = Object.entries(missedTargetKeys).sort((a, b) => b[1] - a[1]);
            document.getElementById('stat-weak').innerText = sortedMiss.length > 0 ? sortedMiss.slice(0, 3).map(m => m[0].toUpperCase()).join("") : "-";
            document.getElementById('fare').innerText = currentFare;
            document.getElementById('fare-child').innerText = childFare;
            document.getElementById('ticket-date').innerText = new Date().toLocaleDateString();
            document.getElementById('result-overlay').classList.remove('hidden');
        }

        function updateStationTimerFrame(timestamp) {
            if (!isPlaying) return;
            const deltaTime = (timestamp - lastTimestamp) / 1000;
            lastTimestamp = timestamp;

            if (!isWaitingForNext) {
                stationTimeRemaining -= deltaTime;
                const ratio = Math.max(0, stationTimeRemaining) / STATION_LIMIT_SEC;
                document.getElementById('station-timer-bar').style.width = `${ratio * 100}%`;
                document.getElementById('station-timer-text').innerText = `${Math.max(0, stationTimeRemaining).toFixed(1)}ç§’`;
                updateTrainPosition(1.0 - ratio);
            }

            if (stationTimeRemaining <= 0 && !isWaitingForNext) {
                goToNextStation(false); // ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ã«ã‚ˆã‚‹æ¬¡é§…ç§»å‹•
            } else {
                stationTimerRequestId = requestAnimationFrame(updateStationTimerFrame);
            }
        }

        function resetStationTimer() {
            if (stationTimerRequestId) cancelAnimationFrame(stationTimerRequestId);
            stationTimeRemaining = STATION_LIMIT_SEC;
            lastTimestamp = performance.now();
            stationTimerRequestId = requestAnimationFrame(updateStationTimerFrame);
        }

        function updateStationDisplay() {
            const st = stations[currentStationIndex];
            if (!st) return;
            document.getElementById('kanji').innerText = st.kanji;
            document.getElementById('ruby').innerText = st.ruby;
            currentKanaList = splitKana(st.ruby);
            currentTargetIndex = 0;
            currentTypedInChar = "";
            confirmedRomajiList = [];
            isWaitingForNext = false;
            renderRomaji();
        }

        function getNNPatterns(index) {
            const nextKana = currentKanaList[index + 1];
            if (!nextKana || "ã‚ã„ã†ãˆãŠã‚„ã‚†ã‚ˆãªã«ã¬ã­ã®ã‚“".includes(nextKana[0])) {
                return ["nn"];
            }
            return ["n", "nn"];
        }

        function renderRomaji(isFinished = false) {
            const display = document.getElementById('romaji-display');
            display.innerHTML = "";
            confirmedRomajiList.forEach(r => {
                const span = document.createElement('span');
                span.className = 'char-correct';
                span.innerText = r;
                display.appendChild(span);
            });

            if (currentTargetIndex < currentKanaList.length && !isFinished) {
                const kana = currentKanaList[currentTargetIndex];
                let patterns = (kana === 'ã‚“') ? getNNPatterns(currentTargetIndex) : (ROMAJI_TABLE[kana] || []);
                
                let target = patterns[0] || "";
                if (kana === 'ã‚“' && patterns.includes("n") && patterns.includes("nn")) {
                    target = currentTypedInChar === "nn" ? "nn" : "n";
                }

                for (let i = 0; i < target.length; i++) {
                    const span = document.createElement('span');
                    if (i < currentTypedInChar.length) {
                        span.className = 'char-correct';
                    } else if (i === currentTypedInChar.length) {
                        span.className = 'char-current';
                    } else {
                        span.className = 'char-next';
                    }
                    span.innerText = target[i];
                    display.appendChild(span);
                }

                for (let i = currentTargetIndex + 1; i < currentKanaList.length; i++) {
                    const span = document.createElement('span');
                    span.className = 'char-next';
                    const nextKana = currentKanaList[i];
                    const nextPatterns = (nextKana === 'ã‚“') ? getNNPatterns(i) : (ROMAJI_TABLE[nextKana] || []);
                    span.innerText = nextPatterns[0] || "";
                    display.appendChild(span);
                }
            }
        }

        function goToNextStation(isInputComplete) {
            if (isInputComplete) {
                isWaitingForNext = true;
                totalStationsCovered++;
                document.getElementById('score').innerText = `${Math.floor(totalStationsCovered / STATIONS_MASTER.length)}å‘¨ / ${totalStationsCovered % STATIONS_MASTER.length}é§…`;
                renderRomaji(true);
                updateTrainPosition(1.0);
                setTimeout(() => {
                    if (!isPlaying) return;
                    currentStationIndex = (currentStationIndex + 1) % stations.length;
                    updateStationDisplay();
                    resetStationTimer();
                }, 500);
            } else {
                totalStationsCovered++;
                document.getElementById('score').innerText = `${Math.floor(totalStationsCovered / STATIONS_MASTER.length)}å‘¨ / ${totalStationsCovered % STATIONS_MASTER.length}é§…`;
                currentStationIndex = (currentStationIndex + 1) % stations.length;
                updateStationDisplay();
                resetStationTimer();
            }
        }

        window.addEventListener('keydown', (e) => {
            if (isReady && e.code === 'Space') { startGame(); return; }
            if (!isPlaying || isWaitingForNext) return;
            if (e.key === 'Shift' || e.key === 'Alt' || e.key === 'Control') return;

            const key = e.key.toLowerCase();
            const kana = currentKanaList[currentTargetIndex];
            const patterns = (kana === 'ã‚“') ? getNNPatterns(currentTargetIndex) : (ROMAJI_TABLE[kana] || []);
            
            let isCorrect = false;

            if (kana === 'ã‚“' && patterns.includes("n") && patterns.includes("nn")) {
                if (currentTypedInChar === "" && key === "n") {
                    currentTypedInChar = "n";
                    isCorrect = true;
                } else if (currentTypedInChar === "n" && key === "n") {
                    confirmedRomajiList.push("nn");
                    currentTargetIndex++;
                    currentTypedInChar = "";
                    isCorrect = true;
                } else if (currentTypedInChar === "n" && key !== "n") {
                    confirmedRomajiList.push("n");
                    currentTargetIndex++;
                    currentTypedInChar = "";
                    handleNextKey(key); 
                    return;
                }
            } else {
                for (let p of patterns) {
                    if (p.startsWith(currentTypedInChar + key)) {
                        isCorrect = true;
                        currentTypedInChar += key;
                        if (p === currentTypedInChar) {
                            confirmedRomajiList.push(currentTypedInChar);
                            currentTargetIndex++;
                            currentTypedInChar = "";
                        }
                        break;
                    }
                }
            }

            if (isCorrect) {
                correctCount++;
                if (currentTargetIndex >= currentKanaList.length) {
                    goToNextStation(true);
                } else {
                    renderRomaji();
                }
            } else {
                handleMiss(key, patterns);
            }
        });

        function handleNextKey(key) {
            if (currentTargetIndex >= currentKanaList.length) {
                goToNextStation(true);
                return;
            }
            const kana = currentKanaList[currentTargetIndex];
            const patterns = (kana === 'ã‚“') ? getNNPatterns(currentTargetIndex) : (ROMAJI_TABLE[kana] || []);
            let isCorrect = false;
            for (let p of patterns) {
                if (p.startsWith(key)) {
                    isCorrect = true;
                    currentTypedInChar = key;
                    if (p === key) {
                        confirmedRomajiList.push(key);
                        currentTargetIndex++;
                        currentTypedInChar = "";
                    }
                    break;
                }
            }
            if (isCorrect) {
                correctCount++;
                if (currentTargetIndex >= currentKanaList.length) {
                    goToNextStation(true);
                } else {
                    renderRomaji();
                }
            } else {
                handleMiss(key, patterns);
            }
        }

        function handleMiss(key, patterns) {
            missCount++;
            const targetChar = (patterns[0] || "")[currentTypedInChar.length] || "?";
            missedTargetKeys[targetChar] = (missedTargetKeys[targetChar] || 0) + 1;
            const display = document.getElementById('romaji-display');
            if (display) {
                display.classList.remove('miss-flash');
                void display.offsetWidth;
                display.classList.add('miss-flash');
            }
        }

        window.addEventListener('resize', handleResize);
        window.onload = () => {
            handleResize();
            updateStatsDisplay();
        };
    </script>
</body>
</html>